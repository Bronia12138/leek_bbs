<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>帖子详情 - 就业交流论坛</title> <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <link rel="icon" href="/leek_bbs/statics/images/favicon.ico" >
    <link rel="stylesheet" href="/leek_bbs/statics/yu-ui/js_css/yu.css">
    <link rel="stylesheet" href="/leek_bbs/statics/layui/css/layui.css">
    <link rel="stylesheet" href="/leek_bbs/statics/bootstrap-3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="/leek_bbs/statics/vue/element-ui/index.css">
    <link rel="stylesheet" href="/leek_bbs/statics/css/head.css">

    <link rel="stylesheet" href="/leek_bbs/statics/css/modern-ui.css">
    <link rel="stylesheet" href="/leek_bbs/statics/css/modern-ui-post.css"> <style>
    /* 保留部分必要的旧样式，用于兼容旧的 JS 逻辑或弹窗 */
    [v-cloak] { display: none; }

    /* 修复回到顶部按钮位置 */
    .box{
        position:fixed; right:30px; bottom: 80px; z-index: 999;
        border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    /* 编辑器高度微调 */
    #themeEditor > div:last-child { min-height: 150px; }
</style>
</head>
<body>

<div id="modern-index-shell" data-page="post-detail">

    <div id="hmc">
        <head_menu_comp :is_login="isLoginShow" ref="fo"></head_menu_comp>
    </div>

    <div class="container" id="postPage" v-cloak>
        <div v-if="PostsInfo!=''">

            <div class="row">
                <nav class="modern-breadcrumb">
                    <a href="/leek_bbs/skipPage/index"><span class="glyphicon glyphicon-home"></span> 首页</a>
                    <span class="separator">/</span>
                    <a href="/leek_bbs/skipPage/index">论坛</a>
                    <span class="separator">/</span>
                    <a href="/leek_bbs/skipPage/index">{{plateObject.plate_vest}}</a>
                    <span class="separator">/</span>
                    <a :href="'/leek_bbs/skipPage/model?pl_type='+plateObject.id">{{plateObject.plate_name}}</a>
                    <span class="separator">/</span>
                    <span class="current-node">正文</span>
                </nav>
            </div>

            <div class="row modern-top-bar">
                <div class="top-title-area">
                    <h2 class="top-post-title" v-if="PostsInfo">{{PostsInfo.title}}</h2>
                </div>
                <div class="top-action-area">
                    <button class="action-icon-btn btn-reply" @click="bottomReply()" title="回复本帖">
                        <i class="layui-icon layui-icon-edit"></i>
                    </button>
                    <button class="action-icon-btn btn-collect" @click="changCollect()" title="收藏">
                        <i class="layui-icon layui-icon-star"></i>
                    </button>
                </div>
            </div>

            <div v-if="isShowTheme" class="row post-card-item">


                <div class="col-md-12">
                    <h1 class="post-title-h4">
                        <span v-if="PostsInfo.post_status==2" class="label label-danger">置顶</span>
                        <span v-else-if="PostsInfo.post_status==4" class="label label-warning">精华</span>
                        {{PostsInfo.title}}
                    </h1>
                </div>

                <div class="col-md-2 user-side-panel">
                    <div class="discard-posit">
                        <div class="user-avatar-box" @mouseenter="queryUserStatus(PostsInfo.user_id)">
                            <a :href="'/leek_bbs/skipPage/personal?id='+PostsInfo.user_id">
                                <img :src="'/leek_bbs/'+PostsInfo.picture" class="img-circle" width="80" height="80">
                            </a>
                            <div v-if="online_status" class="badge" style="background: #52c41a; margin-top:5px;">在线</div>
                            <div v-else class="badge" style="background: #d9d9d9; margin-top:5px;">离线</div>
                        </div>

                        <a href="javascript:;" class="user-name-link">{{PostsInfo.post_author}}</a>

                        <div class="user-stats-grid">
                            <div class="stat-item"><span>{{PostsInfo.themeCount}}</span><br><span>主题</span></div>
                            <div class="stat-item"><span>{{PostsInfo.postsCount}}</span><br><span>帖子</span></div>
                            <div class="stat-item"><span>{{PostsInfo.total_integral}}</span><br><span>积分</span></div>
                        </div>

                        <div class="user-badges">
                            <span class="label label-info">{{PostsInfo.grade.name}}</span>
                            <div style="margin-top: 5px;">
                                <img :src="'/leek_bbs/statics/images'+PostsInfo.grade.img" alt="等级" title="等级">
                            </div>
                        </div>

                        <div class="user-actions" v-if="isOneself(PostsInfo.user_id)">
                            <button class="btn btn-default btn-xs btn-block" @click="addUserAttention(PostsInfo.user_id,PostsInfo.picture)">
                                + 关注
                            </button>
                            <button class="btn btn-primary btn-xs btn-block" @click="openWindow1(PostsInfo)">
                                发消息
                            </button>
                        </div>
                    </div>
                </div>

                <div class="col-md-10 content-side-panel">
                    <div class="post-header-meta">
                        <span>
                            发表于 {{PostsInfo.publish_time|format}} &nbsp;|&nbsp;
                            <a v-show="readPattern" href="javascript:;" @click="handleCurrentChange(PostsInfo.user_id,1)">只看楼主</a>
                            <a v-show="!readPattern" href="javascript:;" @click="handleCurrentChange()">查看全部</a>
                        </span>
                        <span class="label label-warning">楼主</span>
                    </div>

                    <div class="post-content-body">
                        <div v-html="PostsInfo.content"></div>
                    </div>

                    <div class="post-footer-actions">
                        <div class="action-btn-group">
                            <a class="btn" @click="postsShare()" title="分享">
                                <i class="layui-icon layui-icon-share"></i> {{PostsInfo.share_count}}
                            </a>
                            <a class="btn" @click="changPostData(2)" title="支持">
                                <i class="glyphicon glyphicon-thumbs-up"></i> {{PostsInfo.post_top}}
                            </a>
                            <a class="btn" @click="changPostData(3)" title="反对">
                                <i class="glyphicon glyphicon-thumbs-down"></i> {{PostsInfo.post_tread}}
                            </a>
                        </div>

                        <div>
                            <a class="btn" style="color: #1e80ff;" href="javascript:;" @click="citePostReply()">
                                <i class="layui-icon layui-icon-reply-fill"></i> 回复
                            </a>
                            <a class="btn" style="color: #86909c;" href="javascript:;" @click="reportPosts(PostsInfo.user_id,PostsInfo.id,1)">
                                举报
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row post-card-item reply-item" v-for="(item,index) in PostsInfo.listPosts" :key="index">
                <div class="col-md-2 user-side-panel">
                    <div class="discard-posit">
                        <div class="user-avatar-box" @mouseenter="queryUserStatus(item.pd_uid)">
                            <a :href="'/leek_bbs/skipPage/personal?id='+item.pd_uid">
                                <img :src="'/leek_bbs/'+item.pd_picture" class="img-circle" width="80" height="80">
                            </a>
                        </div>

                        <a href="javascript:;" class="user-name-link">{{item.pd_nickname}}</a>

                        <div class="user-stats-grid">
                            <div class="stat-item"><span>{{item.themeCount}}</span><br><span>主题</span></div>
                            <div class="stat-item"><span>{{item.postsCount}}</span><br><span>帖子</span></div>
                        </div>

                        <div class="user-badges">
                            <span class="label label-default">{{item.grade.name}}</span>
                            <div><img :src="'/leek_bbs/statics/images'+item.grade.img" style="max-width: 100%;"></div>
                        </div>

                        <div class="user-actions" v-show="isOneself(item.pd_uid)">
                            <button class="btn btn-default btn-xs btn-block" @click="addUserAttention(item.pd_uid,item.pd_picture)">关注</button>
                            <button class="btn btn-primary btn-xs btn-block" @click="openWindow2(item)">私信</button>
                        </div>
                    </div>
                </div>

                <div class="col-md-10 content-side-panel">
                    <div class="post-header-meta">
                        <span>
                            发表于 {{item.reply_time|format}}
                        </span>

                        <span>
                            <span v-if="item.seat==1" class="label label-danger floor-badge">沙发</span>
                            <span v-else-if="item.seat==2" class="label label-warning floor-badge">板凳</span>
                            <span v-else class="label label-default floor-badge">{{item.seat}} 楼</span>
                        </span>
                    </div>

                    <div class="post-content-body" id="post-text">
                        <div v-html="item.pd_content"></div>
                    </div>

                    <div class="post-footer-actions">
                        <div></div> <div class="action-btn-group">
                        <a class="btn" style="color: #1e80ff;" href="javascript:;" @click="citePostReply(item)">
                            <i class="layui-icon layui-icon-reply-fill"></i> 回复
                        </a>
                        <a class="btn" style="color: #999;" href="javascript:;" @click="reportPosts(item.pd_uid,item.pid,2)">
                            举报
                        </a>
                    </div>
                    </div>
                </div>
            </div>

            <div class="row" style="margin-top: 20px; text-align: right;">
                <el-pagination
                        background
                        @current-change="handleCurrentChange"
                        :current-page.sync="currentPage"
                        :page-size="pageSize"
                        layout="prev, pager, next, jumper"
                        :total="total">
                </el-pagination>
            </div>

            <div class="reply-editor-section">
                <div class="editor-user-side">
                    <img id="changSrc" :src="editorAvatar" class="img-circle" width="64" height="64" style="border: 1px solid #ddd;">                    <div style="margin-top: 10px; font-weight: bold;">发表回复</div>
                </div>

                <div class="editor-main-side">
                    <div v-if="!isLogin" class="alert alert-warning text-center">
                        你需要 <a href="javascript:;" onclick="layui.login()">登录</a> 后才能回帖 | <a href="javascript:;" onclick="layui.register()">立即注册</a>
                    </div>
                    <div v-else>
                        <div id="themeEditor" style="background: #fff;"></div>
                        <div style="margin-top: 15px; display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <el-checkbox v-model="checkbox">回帖后跳到最后一页</el-checkbox>
                            </div>
                            <button class="btn btn-primary modern-btn-primary" @click="replyPost()">
                                <i class="layui-icon layui-icon-release"></i> 发表回复
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div id="exist" v-else style="display:none; text-align: center; padding: 100px 0;">
            <img src="/leek_bbs/statics/images/error.gif" alt="error">
            <h3 style="color: #666; margin-top: 20px;">指定的主题不存在或已被删除</h3>
            <a class="btn btn-default" style="margin-top: 10px;" @click="back">返回上一页</a>
        </div>
    </div>


    <footer>
        <div class="row">
            <p style="text-align: center; color: #86909c; font-size: 14px; margin: 40px 0; line-height: 1.8;">
                <span>© 2026 就业交流论坛 版权所有</span>
                <br>
                <span>邮箱：hanser12581@gmail.com | 友链：www.bronia.xyz</span>
            </p>
        </div>
    </footer>
</div>

<div id="box" class="box">
    <div class="box-in"></div>
</div>

<script src="/leek_bbs/statics/component/common_import.js"></script>
<!-- vue-element插件 -->
<script src="/leek_bbs/statics/vue/element-ui/index.js"></script>
<script src="/leek_bbs/statics/component/head_menu.js"></script>
<!--wangEditor编辑器-->
<script src="/leek_bbs/statics/component/wangEditor.min.js"></script>
<script src="/leek_bbs/statics/component/wangEditCommon.js"></script>
</body>
<script>
    // 仅仅添加一个帮助函数，用于在Vue加载后修正部分老旧的DOM表现
    function getUrlParam(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
        var r = window.location.search.substr(1).match(reg);
        if (r != null) return decodeURIComponent(r[2]);
        return null;
    }
    let timer  = null;
    let replyIndex = null;
    box.onclick = function(){
        cancelAnimationFrame(timer);
        timer = requestAnimationFrame(function fn(){
            var oTop = document.body.scrollTop || document.documentElement.scrollTop;
            if(oTop > 0){
                scrollTo(0,oTop-50);
                timer = requestAnimationFrame(fn);
            }else{
                cancelAnimationFrame(timer);
            }
        });
    };

    let postApp = new Vue({
        el:"#postPage",
        data:{
            PostsInfo:"",
            gradeRefer:"",
            isShowTheme:false,
            isLogin:false,
            readPattern:true,   //显示阅读模式
            theme_id:"",
            themeName:"",   //标题
            plateObject:"",  //板块对象
            online_status:false,
            checkbox:false,
            pageSize:10,
            currentPage:1,  //当前页
            total:0,
            editorAvatar: '/leek_bbs/statics/images/head_portrait/comiis_nologin.jpg', // 编辑器头像

        },
        methods:{
            back(){
                window.history.back(-1);
            },
            isOneself(uid){
                if (userInfo != null){
                    if (userInfo.id != uid) {
                        return true;
                    }
                    return false;
                }
                return true;
            },
            changCollect(){ //收藏
                if (userInfo != null){
                    axios.post('/leek_bbs/bbs/postBrowse/postsCollect',{
                        id:this.PostsInfo.id,
                        u_id:userInfo.id,
                        title:this.PostsInfo.title,
                        source_plate:this.plateObject.plate_name,
                        type:"1"
                    }).then(response => {
                        let data = response.data;
                        if (data.msg == "success"){
                            ui.success("帖子收藏成功",3000,true);
                            this.handleCurrentChange();
                        }else if (data.code == "400060"){
                            ui.alert(data.msg,2000,true);
                        }else {
                            ui.error("帖子收藏失败",2000,true);
                        }
                    }).catch(error => {
                        console.log(error);
                    })
                }else {
                    layui.login();
                }
            },
            postsShare(){
                if (userInfo != null){
                    axios.post('/leek_bbs/bbs/postBrowse/postsShare',{
                        user_id:userInfo.id,
                        post_id:this.theme_id,
                        post_title:this.PostsInfo.title,
                        plate_name:this.plateObject.plate_name
                    }).then(response => {
                        let data = response.data;
                        if(data.msg == "success"){
                            ui.success("分享成功",3000,true);
                            this.handleCurrentChange();
                        } else if (data.code == "500062") {
                            ui.alert(data.msg,2000,true);
                        } else {
                            ui.error(data.msg,2000,true);
                        }

                    })
                } else {
                    layui.login();
                }

            },
            changPostData(val){
                if (userInfo != null){
                    let map,str;
                    let uid = userInfo.id;
                    if (val == 1){  //评分+1
                        map = {id:this.PostsInfo.id,uid:uid,post_grade:this.PostsInfo.post_grade};
                        str = "评分+1";
                    } else if (val == 2){   //顶+1
                        map = {id:this.PostsInfo.id,uid:uid,post_top:this.PostsInfo.post_top};
                        str = "顶+1";
                    } else {    //踩+1
                        map = {id:this.PostsInfo.id,uid:uid,post_tread:this.PostsInfo.post_tread};
                        str = "踩+1";
                    }
                    axios.post('/leek_bbs/bbs/postBrowse/updatePosts',map).then(response => {
                        let data = response.data;
                        if (data.msg == "success"){
                            ui.success(str,2000,true);
                            this.handleCurrentChange();
                        }else if (data.code == "500060"){
                            ui.alert(data.msg,2000,true);
                        } else {
                            ui.error("操作失败",2000,true);
                        }
                    }).catch(error => {
                        console.log(error);
                    })
                }else {
                    layui.login();
                }

            },
            handleCurrentChange(val,sign) {
                if (sign == null || sign != 1){
                    val = null;
                    this.readPattern = true;
                }else {
                    this.currentPage = 1;
                }
                axios.post('/leek_bbs/bbs/postBrowse/listPosts',{
                    post_id:this.theme_id,       //主题id,需从url中获取
                    pd_uid:val,
                    currentPage: this.currentPage,
                    pageSize: this.pageSize
                }).then(response => {
                    let dataObject = response.data;
                    //console.log(dataObject);
                    if (dataObject.data[0] != null && dataObject.data[0] != "") {
                        //window.history.back(-1);
                        this.PostsInfo = dataObject.data[0];
                        this.total = dataObject.total;
                        document.title = this.PostsInfo.title;
                        this.themeName = this.PostsInfo.title;
                        this.getPlateInfo(this.PostsInfo.plate_id);
                        if (sign == 1){
                            this.readPattern = false;
                            if (val != this.PostsInfo.user_id) {
                                this.isShowTheme = false;
                            }else {
                                this.isShowTheme = true;
                                if (this.currentPage != 1){     //是否显示主题内容
                                    this.isShowTheme = false;
                                }else {
                                    this.isShowTheme = true;
                                }
                            }
                        }else {
                            if (this.currentPage != 1){     //是否显示主题内容
                                this.isShowTheme = false;
                            }else {
                                this.isShowTheme = true;
                            }
                        }
                    }else {
                        if (this.total != 0) {
                            console.log(this.PostsInfo.listPosts);
                            this.PostsInfo.listPosts = [];
                            //this.PostsInfo = dataObject.data[0];
                            this.total = 1;
                            this.readPattern = false;
                        }else {
                            $("#exist").css("display","block");
                            document.title = "帖子不存在或正在审核";
                        }
                    }

                }).catch(error => {
                    console.log(error);
                })
            },
            queryUserStatus(user_id){
                axios.get(`/leek_bbs/findUserStatus?uid=${user_id}`).then(response => {
                    let data = response.data;
                    //console.log(data);
                    if (data == "1"){
                        this.online_status = true;
                    }else {
                        this.online_status = false;
                    }
                }).catch(error => {
                    console.log(error);
                })
            },
            getPlateInfo(plate_id){
                axios.get(`/leek_bbs/bbs/plate/getPlate?plate_id=${plate_id}`).then(response => {
                    this.plateObject = response.data;
                })
            },
            replyPost(content){
                if (userInfo != null) {
                    //已登录,可以发表回复
                    if (content == null){       //直接回复
                        content = editor.txt.html();  //获取编辑器html
                        if (editor.txt.text() != null && editor.txt.text() != ''){
                            this.replyMethod(content);
                        }
                    }else {     //引用回复
                        this.replyMethod(content);
                    }
                }else {
                    //未登录,要求登录
                    layui.login();
                }
            },
            citePostReply(Object){    //引用他人的回复进行回复发表
                if (userInfo != null){
                    layui.openReplyWindow(Object);
                } else {
                    layui.login();
                }
            },
            bottomReply(){
                //滚动到底部回复
                window.scroll(0,document.body.scrollHeight);
            },
            replyMethod(content) {
                // 将内容中的 "沙比" 和 "sb" 替换为 * 号
                const filteredContent = content.replace(/傻逼|sb/gi, '*');

                let map = {
                    pd_uid: userInfo.id,
                    last_reply: userInfo.username,
                    post_id: this.PostsInfo.id,
                    plate_id: this.plateObject.id,
                    pd_content: filteredContent
                };
                axios.post('/leek_bbs/bbs/postBrowse/postReply', map).then(response => {
                    let data = response.data;
                    if (replyIndex!= null) {
                        layui.replyClose();
                    }
                    if (data.msg == "success") {
                        ui.success("回复发表成功", 1500, true);
                        editor.txt.html('');
                        setTimeout(function () {
                            if (!postApp.checkbox) {
                                // 未选中发帖跳到最后一页
                                postApp.handleCurrentChange();
                            } else {
                                // 向上取整，有小数就整数部分加 1
                                postApp.currentPage = Math.ceil(postApp.total / postApp.pageSize);
                                postApp.handleCurrentChange();
                            }
                        }, 2000)
                    } else {
                        ui.error("回复发表失败", 1500, true);
                    }
                }).catch(error => {
                    console.log(error);
                })
            }
            ,
            reportPosts(uid,pid,type){
                if (userInfo != null){
                    layui.reportPosts(pid,type);
                } else {
                    layui.login();
                }
            },
            addUserAttention(aid,picture){
                console.log(aid+"====="+picture);
                if (userInfo != null){
                    axios.post('/leek_bbs/bbs/postBrowse/addAttention',{
                        uid:userInfo.id,
                        aid:aid
                    }).then(response => {
                        let data = response.data;
                        if (data.msg == "success"){
                            ui.success(`<img src="/leek_bbs/${picture}" width="32" height="32" class="img-circle">&nbsp;关注成功`,3000,true);
                        } else if (data.code == "600016") {
                            ui.alert(data.msg,2000,true);
                        }else {
                            ui.error(data.msg,2000,true);
                        }
                    })
                } else {
                    layui.login();
                }
            },
            openWindow1(info){
                if (userInfo != null){
                    let item = {id:info.user_id,username:info.post_author,img:info.picture};
                    layui.openMessage(item);
                }else {
                    layui.login();
                }
            },
            openWindow2(info){
                if (userInfo != null){
                    let item = {id:info.pd_uid,username:info.pd_nickname,img:info.pd_picture};
                    layui.openMessage(item);
                } else {
                    layui.login();
                }
            },
            judgeReport(uid){
                if (uid != userInfo.id){
                    return true;
                }
                return false;
            }

        },
        created(){
            this.theme_id = getUrlParam("theme_id");
        },
        filters: {
            format(value) {
                let date = new Date(value);
                return `${date.getFullYear()}-${date.getMonth() + 1 < 10 ? '0' + (date.getMonth() + 1) : date.getMonth() + 1}-${date.getDate()} ${date.getHours()}:${date.getMinutes()}:${date.getSeconds()}`;
            },
            seatFormat(value) {
                let seatName;
                if (value == "1"){
                    seatName = "沙发";
                }else if (value == "2"){
                    seatName = "椅子";
                } else if (value == "3"){
                    seatName = "板凳";
                }else if (value == "4"){
                    seatName = "地毯";
                }else if (value == "5"){
                    seatName = "凉席";
                }else if (value == "6"){
                    seatName = "报纸";
                }else if (value == "7"){
                    seatName = "地板";
                }else if (value == "8"){
                    seatName = "地下室";
                }else{
                    seatName = "下水道";
                }
                return seatName;
            }

        }
    });

    layui.define(['layer','layedit','util'],function (exports) {
        const layer = layui.layer,
            layedit = layui.layedit,
            util = layui.util;

        let editIndex = null;
        let index = null;

        setTimeout(function () {
            postApp.handleCurrentChange();
            if (userInfo != null){
                postApp.isLogin = true;
                setTimeout(function () {
                    if (userInfo != null) {
                        postApp.editorAvatar = '/leek_bbs/' + userInfo.picture;
                    }
                    createEdit("themeEditor");
                },300);
            }
        },200);

        //回复引用窗口方法
        exports('openReplyWindow',function (Object) {
            if (Object == null){
                Object = {
                    pd_nickname:postApp.PostsInfo.post_author,
                    reply_time:postApp.PostsInfo.publish_time,
                    pd_content:postApp.PostsInfo.content
                };
            }
            let formatDate = util.toDateString(Object.reply_time, "yyyy-MM-dd HH:mm");
            replyIndex = layer.open({
                type:1,
                id:"layer-r",
                title:`<span style="font-size: 16px;font-weight: bold;">参与/回复主题</span>`,
                content:`<div id="layer-reply">
                        <blockquote style="font-size: 14.5px;">
                            <div style="font-size: 16px;margin-left: 10px;padding: 8px;">RE:&nbsp;${postApp.PostsInfo.title}</div>
                            <div class="citeReply">
                                <div style="position: absolute;left:-8px;top:4px;font-size: 32px;opacity: .6;">“</div>
                                <spna style="margin-left:15px;opacity: 0.7">${Object.pd_nickname}&nbsp;&nbsp;发表于&nbsp;${formatDate}</spna><br>
                                <div class="text-hidden">${Object.pd_content}</div>
                                <div style="position:absolute;right:-6px;bottom:-12px;font-size: 32px;opacity: .6;">”</div>
                            </div>
                        </blockquote>
                        <div style="margin: 18px 10px;"><div id="citeReplyEditor" style="width:98%"></div></div>
                        <div style="margin-left: 0;padding-top:15px;border-top: 1px solid #e5e5e5;">
                            <div style="margin-left: 10px;"><button id="replyBtn" class="btn btn-sm" style="color: #fff;border:none;background-color:rgb(230, 128, 34);">参与/回复主题</button></div>
                        </div>
                        </div>`,
                anim: 2,
                shade: 0,
                maxmin: false,   //最大化
                resize: false,  //关闭拉伸
                area: ['600px', '490px'],
                success: function(layero, index){
                    //$("#layer-r").find(".text-hidden .citeReply").css("display","none");
                    $("#layer-r").find(".text-hidden .citeReply").remove(); //删除上上个引用
                    createEdit2("citeReplyEditor");
                },
                end: function () {
                    replyIndex = null;
                }
            })
        });

        $(document).on("click","#replyBtn",function () {
            let citeHtml ='<div class="citeReply" style="margin-bottom: 20px;">' + $("#layer-reply .citeReply").html() + '</div>';
            let inputContent = editor2.txt.html();
            if (editor2.txt.text() != null && editor2.txt.text() != '') {
                let content = citeHtml + inputContent;
                postApp.replyPost(content);
            }
        });

        //举报
        exports('reportPosts',function (pid,type) {
            layer.open({
                type:2
                ,title:false
                ,content:"/leek_bbs/skipPage/post-report"
                ,area:["62%","55%"]
                ,btn: ['确定', '取消']
                ,yes: function(index, layero){
                    let body = layer.getChildFrame('body', index);
                    //得到iframe页的窗口对象，执行iframe页的方法：iframeWin.method();
                    //var iframeWin = window[layero.find('iframe')[0]['name']];
                    //console.log(body.html()) //得到iframe页的body内容
                    let r_type = body.find('.m-color').text();
                    let r_content = body.find('textarea').val();
                    axios.post('/leek_bbs/bbs/postReport/executeReport',{
                        uid:userInfo.id,
                        pid:pid,
                        r_type:r_type,
                        r_content:r_content,
                        rp_type:type
                    }).then(response => {
                        let data = response.data;
                        layer.close(index);
                        if (data.msg == "success"){
                            ui.success("举报成功",2000,true)
                        } else if (data.code == "600014") {
                            ui.alert(data.msg,2000,true);
                        }else{
                            ui.error(data.msg,2000,true);
                        }
                    })
                }
                ,btn2: function(index, layero){

                }
            })
        });

        exports('replyClose',function () {
            layer.close(replyIndex);
        });

        //暴露打开会话窗口的接口
        exports('openMessage',function(item) {
            if (index == null){
                index = layer.open({
                    type: 1,
                    //id: 'openMessage', //id唯一标识
                    title:'<div class="layui-row" >' +
                        '<div class="layui-col-sm2" style="margin-top: 8px;"><img src="/leek_bbs/'+item.img+'" class="img-circle img-size" alt=""></div>' +
                        '<div class="layui-col-sm2 m-class" style="height: 70px;margin-left: -10px;"><h4 style="line-height:25px;margin-top: 12px;color:#333;">'+item.username+'</h4>' +
                        '</div>' +
                        '</div>',
                    content: `<div id="layer-3" class="layui-container-fluid" >
                    <iframe src="/leek_bbs/skipPage/session" frameborder="0" id="chatSession-W" name="chatSession-W" style="width: 100%; height: 254px;"></iframe>
                    <div class="layui-row" id="layedit">
                        <textarea id="chatEdit" style="display: none;"></textarea>
                    </div>
                    <div class="layui-row">
                        <div class="layui-col-sm4 layui-col-sm-offset8">
                            <div class="m-btn">
                                <button id="closeBtn" class="layui-btn layui-btn-sm">关闭</button>
                                <button id="sendBtn" class="layui-btn layui-btn-sm">发送</button>
                            </div>
                        </div>
                    </div>
                </div>`,
                    /*skin: 'm-bg-color',*/
                    anim: 2,    //动画
                    shade: 0,
                    /*fixed: false,*/
                    maxmin: true,   //最大化
                    resize: false,  //关闭拉伸
                    // scrollbar: false,   //不允许出现滚动条
                    area: ['600px', '522px'],
                    moveEnd: function(layero){
                        /*console.log(layero);*/

                    },
                    success: function(layero, index) {
                        $("#layui-layer"+index).find(".layui-layer-title").addClass("m-layer-title");
                        let str;
                        //获取用户在线状态
                        postApp.queryUserStatus(item.id);
                        setTimeout(() => {
                            console.log(postApp.online_status);
                            if (postApp.online_status == true){
                                str = `<h5 style="color:red;">在线</h5>`;
                            } else {
                                str = `<h5 style="color:black;">【离线】</h5>`;
                            }
                            $("#layui-layer"+index).find(".m-class").append(str);
                        },60);
                        //显示编辑器
                        $("#layer-3").css("display","block");
                        //建立编辑器
                        editIndex = layedit.build('chatEdit',{
                            width:560,  //设置宽度
                            height: 82, //设置编辑器高度
                            tool: [
                                'face' //表情
                                //,'image' //插入图片
                            ]
                        });
                        //获取聊天对象信息
                        tarUser = item;
                        id = item.id;
                    },
                    full: function(layero){ //最大化
                        //调整按钮位置
                        $("#layer-3 .layui-row .m-btn").css({"margin-left":"205px","margin-top":"155px"});
                        //调整用户名称及状态位置
                        layero.find(".layui-layer-title .m-class").css("margin-left","-90px");
                    },
                    min: function(layero){
                        layero.find(".layui-layer-title .m-class").css("display","none");
                    },
                    restore: function(layero){    //还原
                        //还原按钮初始位置
                        $("#layer-3 .layui-row .m-btn").css({"margin-left":"30px","margin-top":"5px"});
                        //还原用户名称及状态位置
                        layero.find(".layui-layer-title .m-class").css("margin-left","-10px");
                        layero.find(".layui-layer-title .m-class").css("display","block");
                    },
                    end: function () {
                        //在未还原时,直接关闭弹窗,则还原按钮初始位置
                        $("#layer-3 .layui-row .m-btn").css("margin-left","30px");
                        //隐藏编辑器
                        $("#layer-3").css("display","none");
                        index = null;
                    }

                });
            }
        });

        //发送消息
        $(document).on('click','#sendBtn',function () {
            if (postApp.online_status) {     //用户在线
                //获取发送内容
                let str = layedit.getContent(editIndex);
                if (str != null && str != ''){
                    let date = new Date();
                    ws.send(JSON.stringify({
                        "type": "1",
                        "tarUser": {"userId":tarUser.id},
                        "srcUser": {"userId":userInfo.id},
                        "img":userInfo.picture,
                        "time":date.getTime(),
                        "content": str
                        //"isOneself":true
                    }));
                    //该方法layedit接口中未定义,修改layedit.js文件自己添加的方法
                    layedit.clearContent(editIndex);
                }
            }else {      //不在线
                layer.msg('该用户不在线,请上线后再私聊!',{icon:5,time:1500})
            }
        });
        //关闭聊天窗口
        $(document).on('click','#closeBtn',function () {
            layer.close(index);
        });

        exports('closeWindow',function () {
            layer.closeAll();
        })


    });

    let id = null;      //聊天对象id
    function getId() {

        return id;
    }

</script>
</html>
