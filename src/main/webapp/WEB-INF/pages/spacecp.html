<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>设置</title>
    <link rel="icon" href="/leek_bbs/statics/images/favicon.ico">
    <link rel="stylesheet" href="/leek_bbs/statics/yu-ui/js_css/yu.css">
    <link rel="stylesheet" href="/leek_bbs/statics/layui/css/layui.css">
    <link rel="stylesheet" href="/leek_bbs/statics/bootstrap-3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="/leek_bbs/statics/css/head.css">
    <link rel="stylesheet" href="/leek_bbs/statics/css/modern-ui.css">
    <link rel="stylesheet" href="/leek_bbs/statics/css/modern-ui-spacecp.css">
    <style>
        .container .row .col-sm-2 .row {
            padding-left: 20px;
        }

        .m-hover-bg:hover {
            border-left: 2px solid #ff6f3d;
            background-color: #f3f3f3;
        }

        .m-hover-bg:hover a {
            color: #ff6f3d;
        }

        h5 > a {
            color: #333;
        }

        h5 > a:hover {
            color: #ff6f3d;
        }

        .m-active {
            border-left: 2px solid #ff6f3d;
            background-color: #f3f3f3;
        }

        .layui-tab-title li:hover {
            color: #ff6f3d;
            background-color: #e5e5e5;
            opacity: .9;
        }

        .layui-this {
            font-weight: bold;
        }

        .m-border-bottom {
            padding-top: 10px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e5e5e5;
        }

        .m-border-bottom:hover {
            cursor: pointer;
            color: #ff6f3d;
            background-color: #f5f5f5;
        }

        .layui-tab-content img {
            width: 14px;
            height: 13px;
        }

        .m-left {
            margin-left: 4px;
        }

        .m-right {
            float: right;
            margin-right: 38px;
        }

        .layui-tab form .layui-input {
            width: 352px;
        }

        #tab-plate input:focus {
            border: 1px solid #3879d9 !important;
            outline: none;
        }

        .layui-tab .row {
            margin-left: 5px;
        }

        .layui-unselect .layui-form-select {
            margin-left: -50px;
        }

        .layui-select-title > input {
            width: 145px !important;
        }

        .layui-form-select .layui-edge {
            right: 70px;
        }

        .layui-anim.layui-anim-upbit {
            min-width: 168px;
        }

        .layui-layedit {
            width: 510px;
        }

        .layui-tab .row > ul > li {
            padding: 16px 5px;
            width: 96%;
            border-bottom: 1px solid #e5e5e5;
        }

        .layui-tab .row > ul li img {
            width: 45px;
            height: 45px;
        }

        .layui-tab ul > li > a {
            color: #333;
        }

        .layui-tab ul > li > a:hover {
            color: #ff6f3d;
        }

        #tab-care ul > li button:hover {
            color: #ca0c16;
            background: #fde3e4;
            border: 1px solid #ca0c16;
        }

        .s-margin {
            float: right;
            margin-right: 5px;
            line-height: 42px;
            opacity: .7;
        }

        footer {
            margin-top: 164px;
        }

        .avatar-preview {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #e1e4e8;
            transition: all 0.3s ease;
        }

        .avatar-preview:hover {
            border-color: #ff6f3d;
            box-shadow: 0 4px 16px rgba(255, 111, 61, 0.2);
        }

        /* 邮箱验证样式 */
        .email-verify-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #ff6f3d;
        }

        .email-verify-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #24292e;
        }

        .email-verify-note {
            font-size: 12px;
            color: #586069;
            margin-top: 8px;
            line-height: 1.4;
        }

        .email-field-disabled {
            background-color: #f5f5f5 !important;
            cursor: not-allowed !important;
        }
    </style>
</head>
<body>

<div id="modern-index-shell" data-page="spacecp">
    <div class="container-fluid">
        <div id="hmc">
            <head_menu_comp :is_login="isLoginShow" ref="fo"></head_menu_comp>
        </div>

        <div class="container main-content-wrapper" id="careApp" style="display: none;">
            <div class="row breadcrumb-area">
                <span style="opacity: .8;">
                    <a href="/leek_bbs/skipPage/index" target="_self"><span class="glyphicon glyphicon-home"></span></a>&nbsp;>&nbsp;
                    <a href="javascript:;">设置</a>&nbsp;>&nbsp;
                    <span>修改头像</span>
                </span>
            </div>

            <div class="row" style="margin-top: 20px;">
                <div class="col-sm-2 sidebar-card" id="sidebar-nav">
                    <div class="row sidebar-header">
                        <h4>设置</h4>
                    </div>
                    <div class="row m-hover-bg m-active nav-item" id="userBtn">
                        <h5><a href="javascript:;" target="_self">头像修改</a></h5>
                    </div>
                    <div class="row m-hover-bg nav-item" id="postsBtn">
                        <h5><a href="javascript:;" target="_self">个人资料</a></h5>
                    </div>
                    <div class="row m-hover-bg nav-item" id="plateBtn">
                        <h5><a href="javascript:;" target="_self">密码安全</a></h5>
                    </div>
                    <div class="row m-hover-bg nav-item" id="careBtn">
                        <h5><a href="javascript:;" target="_self">我的关注</a></h5>
                    </div>
                </div>

                <div class="col-sm-8 content-card" style="margin-left:30px;">
                    <div class="layui-tab" id="tab-user" lay-filter="tabUser">
                        <div class="row avatar-section">
                            <h4>修改头像</h4>
                            <div class="row" style="display: flex; align-items: flex-start; gap: 40px; margin-top: 20px;">
                                <div style="text-align: center;">
                                    <p style="margin-bottom: 10px; color: #586069;">当前头像预览</p>
                                    <img src="/leek_bbs/statics/images/02_noavatar_middle.gif"
                                         class="avatar-preview"
                                         id="current-user-avatar">
                                </div>

                                <div style="flex: 1;">
                                    <div class="layui-upload-drag" id="pictureUpload" style="width: 100%; padding: 30px;">
                                        <i class="layui-icon"></i>
                                        <p>点击选择或拖拽新头像</p>
                                        <div class="layui-hide" id="uploadDemoView">
                                            <hr>
                                            <img src="" alt="上传成功后渲染" style="max-width: 196px;">
                                        </div>
                                    </div>
                                    <div style="margin-top: 20px;">
                                        <p style="font-size: 12px; color: #999; margin-bottom: 10px;">* 选择图片后可即时预览，确认无误后请点击下方保存按钮</p>
                                        <button type="button" class="layui-btn layui-btn-primary" id="saveAvatarBtn" style="width: 150px;">
                                            <i class="layui-icon layui-icon-upload"></i> 确认保存修改
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="layui-tab" id="tab-posts" lay-filter="tabPosts" style="display: none;">
                        <div class="layui-tab-content" style="width: 100%; max-width: 700px;">
                            <div class="layui-form" lay-filter="combinedProfile">
                                <input type="hidden" name="id" class="layui-input user-id">
                                <input type="hidden" name="username" class="layui-input user-name">
                                <input type="hidden" name="address" id="addressInp" class="layui-input">

                                <div style="margin-bottom: 30px;">
                                    <h4 style="font-weight: 600; margin-bottom: 20px; padding-left: 10px; border-left: 4px solid #ff6f3d;">基本信息</h4>
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">昵称</label>
                                        <div class="layui-input-block">
                                            <input type="text" name="another_name" lay-verify="required" class="layui-input nickname">
                                        </div>
                                    </div>
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">性别</label>
                                        <div class="layui-input-block">
                                            <input type="radio" name="sex" value="男" title="男" checked>
                                            <input type="radio" name="sex" value="女" title="女">
                                        </div>
                                    </div>
                                    <div class="layui-form-item" id="area-picker">
                                        <label class="layui-form-label">居住地址</label>
                                        <div class="layui-input-inline" style="width: 150px;">
                                            <select name="province" class="province-selector" lay-filter="province-1"></select>
                                        </div>
                                        <div class="layui-input-inline" style="width: 150px;">
                                            <select name="city" class="city-selector" lay-filter="city-1"></select>
                                        </div>
                                        <div class="layui-input-inline" style="width: 150px;">
                                            <select name="county" class="county-selector" lay-filter="county-1"></select>
                                        </div>
                                    </div>
                                    <div class="layui-form-item">
                                        <label class="layui-form-label" id="profession-label">职业</label>
                                        <div class="layui-input-block">
                                            <input type="text" name="profession" class="layui-input">
                                        </div>
                                    </div>
                                </div>

                                <hr class="layui-border-blue" style="margin: 30px 0;">

                                <div style="margin-bottom: 30px;">
                                    <h4 style="font-weight: 600; margin-bottom: 20px; padding-left: 10px; border-left: 4px solid #ff6f3d;">联系方式</h4>

                                    <!-- 邮箱验证说明 -->
                                    <div class="email-verify-section">
                                        <div class="email-verify-title">邮箱验证说明</div>
                                        <p style="font-size: 13px; color: #586069; margin-bottom: 15px;">
                                            修改邮箱需要验证旧邮箱（身份验证）和新邮箱（邮箱有效性）。
                                            请先验证旧邮箱，然后再设置新邮箱。
                                        </p>
                                    </div>

                                    <div class="layui-form-item">
                                        <label class="layui-form-label">手机号码</label>
                                        <div class="layui-input-block">
                                            <input type="text" name="phone" lay-verify="phone" class="layui-input" placeholder="请输入手机号码">
                                        </div>
                                    </div>

                                    <!-- 旧邮箱验证 -->
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">旧邮箱验证</label>
                                        <div class="layui-input-inline" style="width: 300px;">
                                            <input type="email" name="old_email" class="layui-input email-field-disabled" readonly>
                                        </div>
                                        <div class="layui-input-inline" style="width: auto;">
                                            <button type="button" id="sendOldEmailCode" class="layui-btn layui-btn-primary">发送验证码</button>
                                        </div>
                                    </div>
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">旧邮箱验证码</label>
                                        <div class="layui-input-inline">
                                            <input type="text" name="oldEmailCode" placeholder="输入旧邮箱验证码" class="layui-input">
                                        </div>
                                    </div>

                                    <!-- 新邮箱设置 -->
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">新邮箱</label>
                                        <div class="layui-input-inline" style="width: 300px;">
                                            <input type="email" name="email" lay-verify="email" class="layui-input" placeholder="请输入新邮箱地址">
                                        </div>
                                        <div class="layui-input-inline" style="width: auto;">
                                            <button type="button" id="sendNewEmailCode" class="layui-btn layui-btn-primary" disabled>发送验证码</button>
                                        </div>
                                    </div>
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">新邮箱验证码</label>
                                        <div class="layui-input-inline">
                                            <input type="text" name="emailCode" placeholder="输入新邮箱验证码" class="layui-input" disabled>
                                        </div>
                                    </div>
                                    <div class="email-verify-note">
                                        * 注意：修改邮箱需要两步验证：<br>
                                        1. 先验证旧邮箱（身份验证）<br>
                                        2. 再验证新邮箱（邮箱有效性）
                                    </div>
                                </div>

                                <hr class="layui-border-blue" style="margin: 30px 0;">

                                <div style="margin-bottom: 30px;">
                                    <h4 style="font-weight: 600; margin-bottom: 20px; padding-left: 10px; border-left: 4px solid #ff6f3d;">个人介绍</h4>
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">个性签名</label>
                                        <div class="layui-input-block">
                                            <textarea id="bardian-edit" style="display: none;"></textarea>
                                        </div>
                                    </div>
                                </div>

                                <div class="layui-form-item" style="margin-top: 40px; text-align: center;">
                                    <button type="submit" class="layui-btn layui-btn-lg layui-btn-primary" lay-submit="" lay-filter="saveAllProfile" style="padding: 0 50px;">
                                        保存全部个人资料
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="layui-tab" id="tab-plate" lay-filter="tabPlate" style="display: none;">
                        <div class="password-notice">
                            <span>您必须填写原密码才能修改下面的资料</span>
                        </div>
                        <div style="margin-top: 20px;">
                            <div class="layui-form" lay-filter="alterPwdForm">
                                <input type="hidden" name="username" class="layui-input user-name">
                                <div class="layui-form-item">
                                    <label class="layui-form-label">旧密码</label>
                                    <div class="layui-input-inline">
                                        <input type="password" name="oldPwd" lay-verify="required" autocomplete="off" placeholder="请输入旧密码" class="layui-input">
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <label class="layui-form-label">密码</label>
                                    <div class="layui-input-inline">
                                        <input type="password" name="password" placeholder="请输入密码" lay-verify="required|password" autocomplete="off" class="layui-input">
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <label class="layui-form-label">确认密码</label>
                                    <div class="layui-input-inline">
                                        <input type="password" id="classPwd" name="pwd" placeholder="请再次输入密码" lay-verify="required" autocomplete="off" class="layui-input">
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <div class="layui-input-block" style="margin-bottom: 52px;">
                                        <span id="errorRes" style="margin-left:0;font-size: 18px;color: red;"></span>
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <div class="layui-input-block" style="margin-top: -40px;">
                                        <button type="submit" class="layui-btn layui-btn-sm layui-btn-primary" lay-submit="" lay-filter="alterPwdBtn">保存</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="layui-tab" id="tab-care" lay-filter="tabUser" style="display: none;" v-cloak="">
                        <div class="care-section-header">
                            <h3>我的关注</h3>
                            <h4>共{{careList.length}}人</h4>
                        </div>
                        <div class="row">
                            <ul class="care-list">
                                <li v-for="item in careList" :key="item.id">
                                    <a :href="'/leek_bbs/skipPage/personal?id='+item.id" target="_self">
                                        <img :src="'/leek_bbs/'+item.picture" class="img-circle" alt="">
                                        <span>{{item.another_name}}</span>
                                    </a>
                                    <div class="s-margin">
                                        <button class="btn btn-default" @click="deleteCare(item.id)">取消关注</button>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer id="footer">
            <div class="row">
                <p>
                    <span>© 2026 就业交流论坛 版权所有</span>
                    <br>
                    <span>邮箱：hanser12581@gmail.com | 友链：www.bronia.xyz</span>
                </p>
            </div>
        </footer>
    </div>
</div>

<script src="/leek_bbs/statics/component/common_import.js"></script>
<script src="/leek_bbs/statics/component/head_menu.js"></script>
<script src="/leek_bbs/statics/js/my_project_rs.js"></script>

<script>
    const careApp = new Vue({
        el: "#careApp",
        data: {
            careList: [],
            pageNo: 1,
            pageSize: 8,
            total: 10
        },
        methods: {
            fetchData() {
                axios.post(`/leek_bbs/bbs/care/listCare`, {
                    uid: userInfo.id,
                    pageNo: this.pageNo,
                    pageSize: this.pageSize
                }).then(response => {
                    const res = response.data;
                    console.log("展示信息接口");
                    console.log(res);
                    this.careList = res.data;
                    this.total = res.total;
                    this.updatePageDisplay();
                }).catch(error => {
                    console.log(error);
                })
            },

            updatePageDisplay() {
                const graduateStatus = userInfo.graduate_status;
                const professionLabel = graduateStatus === "1" ? "专业" : "职业";
                $("#profession-label").text(professionLabel);
                $("input[name='profession']").val(userInfo.profession || "");
            },

            deleteCare(id) {
                ui.confirm('是否确定取消关注?', (z) => {
                    if (z) {
                        axios.post('/leek_bbs/bbs/care/deleteCare', {
                            'uid': parseInt(userInfo.id),
                            'aid': parseInt(id)
                        }).then(response => {
                            const res = response.data;
                            if (res.code == "500020") {
                                ui.success("取消关注成功", 2000, true);
                                this.fetchData();
                            } else {
                                ui.error(res.msg, 2000, true);
                            }
                        }).catch(error => {
                            console.error(error);
                        });
                    }
                });
            }
        }
    });

    layui.config({
        base: '/leek_bbs/statics/layui/lay-module/layarea/',
        version: '1.0'
    });

    layui.use(['form', 'upload', 'layedit', 'layarea', 'util'], function() {
        let form = layui.form,
            upload = layui.upload,
            layarea = layui.layarea,
            util = layui.util,
            layedit = layui.layedit;

        let address = "";
        let oldEmailVerified = false;
        let newEmailVerified = false;
        let oldEmailCount = 0;
        let newEmailCount = 0;
        let edIndex;
        let isAddressInitialized = false;

        // 1. 头像上传逻辑
        let uploadInst = upload.render({
            elem: '#pictureUpload',
            url: '/leek_bbs/bbs/file/fileupload',
            auto: false,
            bindAction: '#saveAvatarBtn',
            data: {
                id: function() {
                    return userInfo.id;
                }
            },
            choose: function(obj) {
                obj.preview(function(index, file, result) {
                    $('#current-user-avatar').attr('src', result);
                    $('#uploadDemoView').removeClass('layui-hide').find('img').attr('src', result);
                    ui.success("已选择新头像，请点击保存按钮生效", 1000);
                });
            },
            done: function(res) {
                if (res.code == 0) {
                    ui.success('头像修改成功', 2000, true);
                    localStorage.removeItem("initUser");
                    getUserInformation(userInfo.username);
                } else {
                    ui.error('上传失败：' + res.msg, 2000, true);
                }
            },
            error: function() {
                ui.error('上传请求异常', 2000, true);
            }
        });

        // 2. 个人资料保存逻辑 - 修复版
// 修复后的个人资料保存逻辑 - 解决NPE问题
        form.on('submit(saveAllProfile)', function(data) {
            let allFields = data.field;
            console.log("表单原始数据:", allFields);

            // 获取省市区选择器的值
            let province = allFields.province || '';
            let city = allFields.city || '';
            let county = allFields.county || '';

            // 如果省市区选择器没有值，尝试从addressInp获取
            if (!province && !city && !county) {
                let savedAddress = $("#addressInp").val();
                if (savedAddress) {
                    const parsed = parseAddress(savedAddress);
                    province = parsed.province;
                    city = parsed.city;
                    county = parsed.county;
                }
            }

            let fullAddress = province + city + county;
            if (!fullAddress) {
                fullAddress = userInfo.address || '';
            }

            // 获取邮箱信息
            let oldEmail = $('input[name="old_email"]').val() || userInfo.email;
            let newEmail = allFields.email || '';
            let emailChanged = (newEmail && newEmail !== oldEmail);

            // 构建个人资料数据 **不包含 emailCode**
            let profileData = {
                id: userInfo.id,
                username: userInfo.username,
                another_name: allFields.another_name || userInfo.another_name,
                sex: allFields.sex || userInfo.sex,
                province: province,
                city: city,
                county: county,
                address: fullAddress,
                profession: allFields.profession || userInfo.profession,
                phone: allFields.phone || userInfo.phone,
                email: emailChanged ? newEmail : oldEmail // 如果没改邮箱就用旧邮箱
            };

            // 只有在真正修改邮箱时才验证并添加验证码
            if (emailChanged) {
                if (!oldEmailVerified) {
                    ui.error("请先验证旧邮箱（点击发送验证码并输入）", 2000, true);
                    return false;
                }
                if (!newEmailVerified) {
                    ui.error("请先验证新邮箱（点击发送验证码并输入）", 2000, true);
                    return false;
                }
                if (!allFields.emailCode || allFields.emailCode.trim() === '') {
                    ui.error("请输入新邮箱验证码", 2000, true);
                    return false;
                }
                // **关键**：只有确认修改邮箱时才添加 emailCode 字段
                profileData.emailCode = allFields.emailCode.trim();
            }

            console.log("提交的个人资料数据:", profileData);

            // 获取个性签名内容
            let signContent = layedit.getContent(edIndex);
            let signData = {
                id: userInfo.id,
                personalized_sign: signContent
            };

            // 保存个人资料
            axios.post('/leek_bbs/bbs/user/alterUserInfo', profileData).then(response => {
                let data = response.data;
                console.log("保存个人资料响应:", data);

                if (data.code == "500020") {
                    // 个人资料保存成功后保存个性签名
                    axios.post('/leek_bbs/bbs/user/alterUserInfo', signData).then(signResponse => {
                        let signDataRes = signResponse.data;
                        if (signDataRes.code == "500020") {
                            ui.success("全部个人资料保存成功", 2000, true);
                            // 重置邮箱验证状态
                            oldEmailVerified = false;
                            newEmailVerified = false;
                            // 清空验证码输入框
                            $("input[name='oldEmailCode']").val('');
                            $("input[name='emailCode']").val('');
                            // 更新本地用户信息
                            localStorage.removeItem("initUser");
                            // 立即更新本地userInfo对象，避免重新登录才能看到新数据
                            Object.assign(userInfo, profileData);
                            userInfo.personalized_sign = signContent;
                            getUserInformation(userInfo.username);
                        } else {
                            ui.error("个性签名保存失败: " + (signDataRes.msg || "未知错误"), 2000, true);
                        }
                    }).catch(signError => {
                        console.error("保存个性签名失败:", signError);
                        ui.error("个性签名保存失败，请检查网络", 2000, true);
                    });
                } else {
                    ui.error("个人资料保存失败: " + (data.msg || "未知错误"), 2000, true);
                }
            }).catch(error => {
                console.error("保存个人资料失败:", error);
                ui.error("个人资料保存失败，请检查网络", 2000, true);
            });

            return false;
        });

        // 解析地址辅助函数
        function parseAddress(addr) {
            let province = "", city = "", county = "";

            if (!addr) return { province, city, county };

            if (addr.includes("省")) {
                const provinceEnd = addr.indexOf("省") + 1;
                province = addr.substring(0, provinceEnd);
                const remaining = addr.substring(provinceEnd);

                if (remaining.includes("市")) {
                    const cityEnd = remaining.indexOf("市") + 1;
                    city = remaining.substring(0, cityEnd);
                    county = remaining.substring(cityEnd);
                } else {
                    city = remaining;
                }
            } else if (addr.includes("自治区")) {
                const provinceEnd = addr.indexOf("自治区") + 3;
                province = addr.substring(0, provinceEnd);
                const remaining = addr.substring(provinceEnd);

                if (remaining.includes("市")) {
                    const cityEnd = remaining.indexOf("市") + 1;
                    city = remaining.substring(0, cityEnd);
                    county = remaining.substring(cityEnd);
                } else {
                    city = remaining;
                }
            } else if (addr.includes("市") && ["北京", "上海", "天津", "重庆"].some(m => addr.startsWith(m))) {
                const cityEnd = addr.indexOf("市") + 1;
                city = addr.substring(0, cityEnd);
                county = addr.substring(cityEnd);
                province = city;
            } else {
                province = addr;
            }

            return { province, city, county };
        }

        // 初始化省市区选择器函数
        function initAddressPicker() {
            if (isAddressInitialized) return;

            let province = "", city = "", county = "";

            if (userInfo.address) {
                const parsed = parseAddress(userInfo.address);
                province = parsed.province;
                city = parsed.city;
                county = parsed.county;
            }

            console.log("初始化省市区:", { province, city, county });

            try {
                layarea.render({
                    elem: '#area-picker',
                    data: {
                        province: province,
                        city: city,
                        county: county
                    },
                    change: function(res) {
                        address = res.province + res.city + res.county;
                        $("#addressInp").val(address);
                        console.log("选择地址:", address);
                    }
                });

                $("#addressInp").val(userInfo.address || "");
                isAddressInitialized = true;

                // 延迟渲染确保选择器显示正确
                setTimeout(() => {
                    form.render('select');
                }, 100);
            } catch (e) {
                console.error("省市区初始化失败:", e);
            }
        }

        // 初始化用户信息 - 修复版
        setTimeout(() => {
            if (userInfo != null) {
                careApp.fetchData();

                // 关键：先显示容器
                $("#careApp").css("display", "block");

                // 延迟确保DOM渲染完成
                setTimeout(() => {
                    // 初始化用户信息
                    $(".user-id").val(userInfo.id);
                    $(".user-name").val(userInfo.username);
                    $(".nickname").val(userInfo.another_name || "");
                    $("input[name='old_email']").val(userInfo.email || "");
                    $("input[name='phone']").val(userInfo.phone || "");
                    $("input[name='email']").val(userInfo.email || "");

                    // 设置性别
                    const gender = userInfo.sex || "男";
                    $(`input[name="sex"][value="${gender}"]`).prop("checked", true);
                    form.render('radio');

                    // 设置职业标签和值
                    const graduateStatus = userInfo.graduate_status;
                    const professionLabel = graduateStatus === "1" ? "专业" : "职业";
                    $("#profession-label").text(professionLabel);
                    $("input[name='profession']").val(userInfo.profession || "");

                    // 设置头像
                    if (userInfo.picture) {
                        $('#current-user-avatar').attr('src', '/leek_bbs/' + userInfo.picture);
                    }

                    // 初始化省市区
                    initAddressPicker();

                    // 初始化富文本编辑器
                    edIndex = layedit.build('bardian-edit', {
                        height: 160,
                        tool: ['strong', 'face', '|', 'underline', 'del']
                    });

                    if (userInfo.personalized_sign) {
                        layedit.setContent(edIndex, userInfo.personalized_sign);
                    }

                    // 重新渲染整个表单确保所有组件正常
                    form.render();
                }, 100);

                // 如果是从关注链接进入，自动切换到关注Tab
                if (getUrlName("care")) {
                    setTimeout(() => {
                        $("#careBtn").click();
                    }, 300);
                }
            } else {
                layui.login();
            }
        }, 200);

        // 3. 邮箱验证相关功能
        $(document).on("click", "#sendOldEmailCode", function() {
            let oldEmail = $("input[name='old_email']").val();
            if (!oldEmail) {
                ui.error("旧邮箱不能为空", 2000, true);
                return false;
            }

            countDown("old", oldEmail, function(success) {
                if (success) {
                    ui.success("验证码已发送到旧邮箱，请查收", 2000, true);
                }
            });
            return false;
        });

        $(document).on("click", "#sendNewEmailCode", function() {
            let newEmail = $("input[name='email']").val();
            if (!newEmail) {
                ui.error("请先输入新邮箱", 2000, true);
                return false;
            }

            if (newEmail === userInfo.email) {
                ui.error("新邮箱不能与旧邮箱相同", 2000, true);
                return false;
            }

            countDown("new", newEmail, function(success) {
                if (success) {
                    ui.success("验证码已发送到新邮箱，请查收", 2000, true);
                }
            });
            return false;
        });

        $(document).on("blur", "input[name='oldEmailCode']", function() {
            let code = $(this).val();
            if (code && code.length === 6) {
                oldEmailVerified = true;
                $("#sendNewEmailCode").prop("disabled", false);
                $("input[name='emailCode']").prop("disabled", false);
                ui.success("旧邮箱验证通过", 1500, true);
            }
        });

        $(document).on("blur", "input[name='emailCode']", function() {
            let code = $(this).val();
            if (code && code.length === 6) {
                newEmailVerified = true;
                ui.success("新邮箱验证通过", 1500, true);
            }
        });

        // 4. 密码修改表单提交
        form.on('submit(alterPwdBtn)', function(data) {
            if (data.field.password != data.field.pwd) {
                ui.error("两次密码不一致", 2000, true);
                $("#classPwd").focus();
            } else {
                saveUserInfoAdvanced(data.field, 0, function(success) {
                    if (success) {
                        ui.success("密码修改成功", 2000, true);
                    }
                });
            }
            return false;
        });

        // 5. 辅助函数
        function countDown(type, email, callback) {
            console.log(`发送验证码到${type}邮箱:`, email);

            axios.get(`/leek_bbs/bbs/user/sendEmail?email=${encodeURIComponent(email)}`).then(response => {
                let data = response.data;
                console.log("发送验证码响应:", data);

                if (data.msg == "success" || data.code == "500020") {
                    let endTime = new Date().getTime() + 60 * 1000,
                        serverTime = new Date().getTime();

                    let buttonId = type === 'old' ? 'sendOldEmailCode' : 'sendNewEmailCode';
                    let buttonText = type === 'old' ? '重新发送旧邮箱验证码' : '重新发送新邮箱验证码';

                    util.countdown(endTime, serverTime, function(date, serverTime, timer) {
                        let str = date[3];
                        $(`#${buttonId}`).html(`重新发送(${str})`);
                        $(`#${buttonId}`).prop("disabled", true);

                        if (str == 0) {
                            $(`#${buttonId}`).html(buttonText);
                            $(`#${buttonId}`).prop("disabled", false);
                        }
                    });

                    if (type === 'old') {
                        oldEmailCount++;
                    } else {
                        newEmailCount++;
                    }

                    if (callback && typeof callback === 'function') {
                        callback(true);
                    }
                } else {
                    ui.error(data.msg || "验证码发送失败", 2000, true);
                    if (callback && typeof callback === 'function') {
                        callback(false);
                    }
                }
            }).catch(error => {
                console.error("发送验证码失败:", error);
                ui.error("验证码发送失败，请检查网络", 2000, true);
                if (callback && typeof callback === 'function') {
                    callback(false);
                }
            });
        }

        function saveUserInfoAdvanced(user, mark, callback) {
            console.log(`保存用户信息，mark=${mark}:`, user);

            axios.post('/leek_bbs/bbs/user/alterUserInfo', user).then(response => {
                let data = response.data;
                console.log(`保存接口响应，mark=${mark}:`, data);

                if (data.code == "500020") {
                    if (mark == 1) {
                        ui.success("用户信息保存成功", 2000, true);
                    } else if (mark == 3) {
                        ui.success("个性签名保存成功", 2000, true);
                    } else {
                        ui.success("操作成功", 2000, true);
                    }

                    if (callback && typeof callback === 'function') {
                        callback(true);
                    }
                } else if (data.code == "300036") {
                    $("#errorRes").text(data.msg);
                    if (callback && typeof callback === 'function') {
                        callback(false);
                    }
                } else if (data.code == "500023") {
                    ui.error(data.msg, 2000, true);
                    if (callback && typeof callback === 'function') {
                        callback(false);
                    }
                } else {
                    ui.error(data.msg || "保存失败，请检查数据格式", 2000, true);
                    if (callback && typeof callback === 'function') {
                        callback(false);
                    }
                }
            }).catch(error => {
                console.error("保存失败:", error);
                ui.error("保存失败，请检查网络连接", 2000, true);
                if (callback && typeof callback === 'function') {
                    callback(false);
                }
            });
        }
    });

    /**
     * URL参数检测工具函数
     */
    function getUrlName(name) {
        let url = window.location.href;
        return url.indexOf(name) != -1;
    }

    /**
     * Tab切换功能
     */
    $(document).ready(function() {
        $("#userBtn").click(function() {
            switchTab('tab-user');
            setActiveNav($(this));
        });

        $("#postsBtn").click(function() {
            switchTab('tab-posts');
            setActiveNav($(this));
        });

        $("#plateBtn").click(function() {
            switchTab('tab-plate');
            setActiveNav($(this));
        });

        $("#careBtn").click(function() {
            switchTab('tab-care');
            setActiveNav($(this));
        });

        function switchTab(tabId) {
            $('.layui-tab').hide();
            $('#' + tabId).show();
        }

        function setActiveNav($element) {
            $('.nav-item').removeClass('active m-active');
            $element.addClass('active m-active');
        }
    });
</script>
</body>
</html>
