<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>版块详情</title>
	<link rel="icon" href="/leek_bbs/statics/images/favicon.ico" >
	<link rel="stylesheet" href="/leek_bbs/statics/yu-ui/js_css/yu.css">
	<link rel="stylesheet" href="/leek_bbs/statics/layui/css/layui.css">
	<link rel="stylesheet" href="/leek_bbs/statics/bootstrap-3.3.7/css/bootstrap.min.css">
	<link rel="stylesheet" href="/leek_bbs/statics/css/head.css">
	<link rel="stylesheet" href="/leek_bbs/statics/vue/element-ui/index.css">
	<link rel="stylesheet" href="/leek_bbs/statics/css/modern-ui.css">
</head>
<body>

<div id="modern-index-shell" v-cloak>
<!--	<div class="m-theme-toggle-fab" @click="toggleTheme" :title="isDarkMode ? '切换到白昼' : '切换到黑夜'">-->
<!--		<i class="glyphicon" :class="isDarkMode ? 'glyphicon-certificate' : 'glyphicon-adjust'"></i>-->
<!--	</div>-->

	<div id="hmc">
		<head_menu_comp :is_login="isLoginShow" ref="fo"></head_menu_comp>
	</div>

	<div class="m-container container" id="app">

		<div class="m-breadcrumb">
			<a href="/leek_bbs/skipPage/index"><i class="glyphicon glyphicon-home"></i> 论坛</a>
			<span class="m-sep">/</span>
			<a href="#">{{platePostInfo.plate_vest}}</a>
			<span class="m-sep">/</span>
			<span class="m-current">{{platePostInfo.plate_name}}</span>
		</div>

		<div class="m-plate-header m-card">
			<div class="m-plate-cover">
				<img :src="'/leek_bbs/statics/images/'+platePostInfo.plate_photo" :alt="platePostInfo.plate_name">
			</div>
			<div class="m-plate-info">
				<div class="m-plate-title">
					<h1>{{platePostInfo.plate_name}}</h1>
					<div class="m-plate-stats">
						<span>今日 <b>{{todayPostCount}}</b></span>
						<span class="m-dot"></span>
						<span>主题 <b>{{platePostInfo.theme}}</b></span>
						<span class="m-dot"></span>
						<span>排名 <b>{{plateRanking}}</b></span>
					</div>
				</div>
				<p class="m-plate-desc">欢迎来到 {{platePostInfo.plate_name}} 版块，共同建设和谐内容社区。</p>
			</div>
			<div class="m-plate-action">
				<button class="m-btn-favorite" @click="collectPlate()">
					<i class="glyphicon glyphicon-star-empty"></i> 收藏本版
				</button>
			</div>
		</div>

		<div class="row">
			<div class="col-sm-8">

				<div class="m-filter-bar m-card">
					<div class="m-filter-left">
						<select v-model="select1" @change="selectTimeChange" class="m-select">
							<option value="0">全部时间</option>
							<option value="1">一天内</option>
							<option value="2">两天内</option>
							<option value="3">一周内</option>
						</select>
						<select v-model="select2" @change="selectChange" class="m-select">
							<option value="1">默认排序</option>
							<option value="2">最新发帖</option>
							<option value="3">最热回复</option>
							<option value="5">最后发表</option>
						</select>
					</div>
					<div class="m-filter-right">
						<a href="javascript:;" :class="{active: selectType=='new'}" @click="getPlatePostInfo(pl_type,'new')">最新</a>
						<a href="javascript:;" :class="{active: selectType=='hot'}" @click="getPlatePostInfo(pl_type,'hot')">热门</a>
						<a href="javascript:;" :class="{active: selectType=='essence'}" @click="getPlatePostInfo(pl_type,'essence')">精华</a>
					</div>
				</div>

				<div class="m-post-list-wrapper m-card">
					<div class="m-post-section" v-if="isTopInfo.length > 0 && judgeIstopPost">
						<div class="m-section-label">置顶主题</div>
						<div v-for="item in isTopInfo" :key="'top-'+item.id" class="m-post-item is-top">
							<div class="m-item-avatar">
								<img :src="'/leek_bbs/'+item.picture">
							</div>
							<div class="m-item-main">
								<a :href="'/leek_bbs/skipPage/blogPage?theme_id='+item.id" class="m-item-title" @click="handleBrowseCount(item.id)">
									<span class="m-tag-top">置顶</span> {{item.title}}
								</a>
								<div class="m-item-meta">
									<span class="m-author">{{item.post_author}}</span>
									<span>{{item.publish_time | formatDate}}</span>
								</div>
							</div>
							<div class="m-item-stats">
								<span><i class="glyphicon glyphicon-eye-open"></i> {{item.browse_count}}</span>
								<span><i class="glyphicon glyphicon-comment"></i> {{item.reply_count}}</span>
							</div>
						</div>
					</div>

					<div class="m-post-section">
						<div class="m-section-label">版块主题</div>
						<div v-for="item in otherInfo" :key="item.id" class="m-post-item">
							<div class="m-item-avatar">
								<img :src="'/leek_bbs/'+item.picture">
							</div>
							<div class="m-item-main">
								<a :href="'/leek_bbs/skipPage/blogPage?theme_id='+item.id" class="m-item-title" @click="handleBrowseCount(item.id)">
									{{item.title}}
								</a>
								<div class="m-item-meta">
									<span class="m-author">{{item.post_author}}</span>
									<span>{{item.publish_time | formatDate}}</span>
									<span class="m-sep">·</span>
									<span>最后回复 {{item.last_reply_time | dateChangeFormat1}}</span>
								</div>
							</div>
							<div class="m-item-stats">
								<span><i class="glyphicon glyphicon-eye-open"></i> {{item.browse_count}}</span>
								<span><i class="glyphicon glyphicon-comment"></i> {{item.reply_count}}</span>
							</div>
						</div>

						<div class="m-empty-state" v-if="!otherInfo || otherInfo.length === 0">
							<p>该版块暂无数据</p>
						</div>
					</div>

					<div class="m-pagination-container">
						<el-pagination
								background
								layout="prev, pager, next"
								@current-change="handleCurrentChange"
								:current-page="currentPage"
								:page-size="pageSize"
								:total="totalCount">
						</el-pagination>
					</div>
				</div>

				<div class="m-quick-post-modern m-card">
					<div class="m-card-header-sleek">
						<span class="m-header-icon"><i class="glyphicon glyphicon-edit"></i></span>
						<span class="m-header-text">发表新动态</span>
					</div>
					<div class="m-card-body-modern">
						<div class="m-input-wrapper-modern">
							<input type="text" id="title" placeholder="给你的帖子起一个吸引人的标题..." class="m-input-minimal">
						</div>
						<div class="m-editor-wrapper-modern">
							<div id="editor_two"></div>
							<div class="m-editor-mask" v-if="!loggingStatus">
								<p>你需要登录后才能发表主题</p>
								<div class="m-mask-btns">
									<a href="javascript:;" onclick="layui.login()" class="m-btn-primary">立即登录</a>
									<a href="javascript:;" onclick="layui.register()" class="m-btn-link">立即注册</a>
								</div>
							</div>
						</div>
						<div class="m-post-actions-modern" v-if="loggingStatus">
							<span class="m-post-tips"><i class="glyphicon glyphicon-info-sign"></i> 友善发言，共建和谐社区</span>
							<button class="m-btn-submit-modern" @click="quickSendPost()">
								<span>发布主题</span>
								<i class="glyphicon glyphicon-send"></i>
							</button>
						</div>
					</div>
				</div>
			</div>

			<div class="col-sm-4">
				<div class="m-sticky-sidebar">
					<div class="m-side-card m-card">
						<div class="m-card-header">版块公告</div>
						<div class="m-notice-content">
							<template v-if="notices">
								<h4 class="m-notice-title">{{notices.n_title}}</h4>
								<div class="m-notice-body" v-html="notices.n_content"></div>
								<div class="m-notice-author">—— {{notices.another_name}}</div>
							</template>
							<p v-else class="m-empty-text">暂无公告</p>
						</div>
					</div>

					<div class="m-side-card m-card">
						<div class="m-card-header">热点动态</div>
						<div class="m-hot-list">
							<div v-for="(item, index) in postHeats" :key="index" class="m-hot-item">
								<span class="m-hot-rank" :class="'rank-' + (index+1)">{{index + 1}}</span>
								<a :href="'/leek_bbs/skipPage/blogPage?theme_id='+item.id" class="m-hot-title">{{item.title}}</a>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>


<script src="/leek_bbs/statics/component/common_import.js"></script>

<script src="/leek_bbs/statics/component/head_menu.js"></script>
<!-- vue-element插件 -->
<script src="/leek_bbs/statics/vue/element-ui/index.js"></script>
<!--富文本编辑器-->
<script src="/leek_bbs/statics/component/wangEditor.min.js"></script>
<script src="/leek_bbs/statics/component/wangEditCommon.js"></script>
<script>
	// 在 model.html 的 script 部分，创建 Vue 实例之前添加
	function getUrlParam(name) {
		let reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
		let r = window.location.search.substr(1).match(reg);
		if (r != null) return decodeURI(r[2]); return null;
	}
    initLayui();
	setTimeout(function () {
        var app =new Vue({
            el:"#app",
            data:{
                pageSize:5,			//每页显示多少条数据
				isDarkMode: false, // 添加深色模式状态
				currentPage:1,		//当前页
                totalCount:0,		//总数据条数
                platePostInfo:'',
                judgeIstopPost:true, //是否显示置顶信息
                isTopInfo:[], //置顶主题数据
                otherInfo:[], //其他主题数据
                postHeats:[],//热点动态
                selectType:'default',
                selectTime:'', //查看时间
				select1:"0", //时间下拉框选择
                select2:'1', //类型下拉框选择
                editorContent:'', //富文本编辑器内容
                todayPostCount:'', //今日发表主题数
                plateRanking:[], //版块排名
                notices:'', //版块公告
                pl_type:""
            },
            computed:{
                loggingStatus:function () {	//判断是否登录
                    if (userInfo==null){
                        return false;
                    }else {
                        return true;
                    }
                }
            },

            methods:{
				toggleTheme() {
					this.isDarkMode = !this.isDarkMode;
					const shell = document.getElementById('modern-index-shell');
					if (shell) {
						if (this.isDarkMode) {
							shell.classList.add('dark-theme');
							// 保存主题偏好到localStorage
							localStorage.setItem('modern-ui-theme', 'dark');
						} else {
							shell.classList.remove('dark-theme');
							localStorage.setItem('modern-index-shell', 'light');
						}
					}
				},

				// 添加一个初始化主题的方法
				initTheme() {
					// 检查localStorage中的主题设置
					const savedTheme = localStorage.getItem('modern-ui-theme');
					const shell = document.getElementById('modern-index-shell');

					if (savedTheme === 'dark') {
						this.isDarkMode = true;
						if (shell) {
							shell.classList.add('dark-theme');
						}
					} else {
						this.isDarkMode = false;
						if (shell) {
							shell.classList.remove('dark-theme');
						}
					}
				},
				handleBrowseCount(postId) {
					// 改用GET请求，参数通过params传递
					axios.get("http://localhost:8080/leek_bbs/bbs/postBrowse/clickAddBrowseCount", {
						params: { id: postId } // 匹配后端@RequestParam("id")
					})
							.then(response => {
								// 后端返回成功（假设返回1表示成功）
								if (response.data === 1) {
									// 更新当前主题的浏览次数（同时处理普通主题和置顶主题两种情况）
									const targetIndex = this.otherInfo.findIndex(item => item.id === postId);
									if (targetIndex !== -1) {
										this.otherInfo[targetIndex].browse_count += 1;
										return;
									}
									const topTargetIndex = this.isTopInfo.findIndex(item => item.id === postId);
									if (topTargetIndex !== -1) {
										this.isTopInfo[topTargetIndex].browse_count += 1;
									}
								}
							})
							.catch(error => {
								console.error("浏览次数增加失败", error);
							});
				},

                //收藏板块
                collectPlate(){
                    if (userInfo != null){
                        axios.post('/leek_bbs/bbs/postBrowse/postsCollect',{
                            id:this.platePostInfo.id,
                            u_id:userInfo.id,
                            title:this.platePostInfo.plate_name,
                            source_plate:this.platePostInfo.plate_name,
                            type:"2"
                        }).then(response => {
                            let data = response.data;
                            if (data.msg == "success"){
                                ui.success("板块收藏成功",3000,true);
                                this.handleCurrentChange();
                            }else if (data.code == "400060"){
                                ui.alert("板块已收藏过了",2000,true);
                            }else {
                                ui.error("板块收藏失败",2000,true);
                            }
                        }).catch(error => {
                            console.log(error);
                        })
                    }else {
                        layui.login();
                    }
                },
                //版块公告
                init (){
                    let plate_id=getUrlParam("pl_type");
                    axios.get("/leek_bbs/bbs/plate/selectNotice?id="+plate_id, {

                    }).then(response => {
                            var data = response.data;
                            this.notices =data;
					});
                },
                /*获取今日版块今日发表主题数量*/
				getTodayPostNum(){
                    var date = new Date();
                    var year = date.getFullYear();
                    var month = date.getMonth()+1;
                    var day = date.getDate();
                    var selectTime =year+"-"+month+"-"+day;
				  axios.post("/leek_bbs/bbs/plate/getTodayPostNum",{
				      pl_type:getUrlParam('pl_type'),
					  selectType:"selectTimePost",
					  selectTime:selectTime,
				  }).then((response)=> {
					  this.todayPostCount=response.data;
                  })
				},
				getPlatePostInfo(pl_type,selectType,selectTime){
					axios.post("/leek_bbs/bbs/plate/getPlatePostInfo",{
                        //时间查看方式:时间
                        selectTime:selectTime,
                        //类别查看方式
                        selectType:selectType,
                        //查看板块的id
                        pl_type:pl_type,
                        // 每页显示的条数
                        pageSize:this.pageSize,
                        // 显示第几页
                        currentPage:this.currentPage,
					}).then((response)=> {
                        //判断是否有置顶的主题数据,有则将数据赋予isTopInfo
                        if(response.data.list2!=null){
                            this.isTopInfo=response.data.list2.postList;
                        }else{
                            this.isTopInfo=[];
                        }
                        //其他状态主题数据
                        this.selectType=selectType; //修改查看类型
                        if (response.data.list!=null){
                            this.otherInfo =response.data.list.postList;
                        }else{
                            this.otherInfo=[];
                        }
                        this.platePostInfo=response.data.plateInfo; //版块主题数据
						document.title=this.platePostInfo.plate_name;
                        this.totalCount=response.data.totalCount;	//总页数

						if (this.plateRanking.length < 1){
							//查看版块的排名
							for (var i = 0 ;i< response.data.plateRanking.length;i++){
								this.plateRanking.push(response.data.plateRanking[i].id)
							}
							var plateRank = getUrlParam('pl_type'); //版块id
							this.plateRanking =this.plateRanking.indexOf(parseInt(plateRank))+1;
						}
						// 确保图片路径正确
						if(response.data.plateInfo && response.data.plateInfo.plate_photo) {
							this.platePostInfo = response.data.plateInfo;
							// 确保图片路径是完整路径
							if(this.platePostInfo.plate_photo && !this.platePostInfo.plate_photo.startsWith('/')) {
								this.platePostInfo.plate_photo = this.platePostInfo.plate_photo;
							}
						}

                    });
                },
                /*快速发帖*/
                quickSendPost(){
                   let plateId = getUrlParam("pl_type");
                    if($("#title").val()==null||$("#title").val()==''){
                        ui.error("标题不能为空",1500,true);
                    }else if(editor.txt.html()=='<p><br></p>'){
                        ui.error("内容不能为空",1500,true);
                    }else {
                        axios.post("/leek_bbs/bbs/userPost/insertPost", {
                            userId: userInfo.id,	//发帖用户id
                            title: $("#title").val(), //获取当前帖子主题
                            postAuthor: userInfo.another_name, //帖子作者
                            plateId: plateId, //帖子所在版块id
                            content: editor.txt.html(), //内容
                            publishTime: new Date().getTime(), //获取当前时间的时间戳
                            lastReply: userInfo.another_name,//默认设置自己为最后回复者
                            lastReplyTime: new Date().getTime(), //默认获取当前时间戳
                        }).then(function (response) {
                            // var index = parent.layer.getFrameIndex(window.name); //获取上一层弹出层的索引
                            //parent.layer.closeAll();	//关闭上一层弹出层
                            layer.closeAll();
                            // console.log(response);
                            if (response.data == 1) {
                                //this.$options.methods.getPlatePostInfo(getUrlParam("pl_type"),this.selectType,this.selectTime);
                                $("#title").val(""); //情况标题内容
                                ui.success("发表主题成功,等待审核", 1500, true);
                                this.getPlatePostInfo(); //调用vue给window暴露的方法
                                editor.txt.html('<p><br></p>'); //清空富文本编辑器内容

                            } else {
                                ui.error("发表主题失败", {icon: 5, time: '1500'});
                            }
                        })
                    }

				},
                /*修改时间下拉框查看状态*/
                selectTimeChange(){
                    if(this.select1==0){
                        this.selectType="default";
                        this.getPlatePostInfo(getUrlParam('pl_type'),'default');
					}else if(this.select1==1){
                        var date = new Date();
                        var year = date.getFullYear();
                        var month = date.getMonth()+1;
                        var day = date.getDate()-1;
						var selectTime =year+"-"+month+"-"+day;
						this.selectTime = selectTime;
                        this.selectType="selectTimePost";
                        this.getPlatePostInfo(getUrlParam('pl_type'),'selectTimePost',selectTime)
                    }else if(this.select1==2){
                        var date = new Date();
                        var year = date.getFullYear();
                        var month = date.getMonth()+1;
                        var day = date.getDate()-2;
                        var selectTime =year+"-"+month+"-"+day;
                        this.selectTime = selectTime;
                        this.selectType="selectTimePost";
                        this.getPlatePostInfo(getUrlParam('pl_type'),'selectTimePost',selectTime)
                    }else if(this.select1==3){
                        var date = new Date();
                        var year = date.getFullYear();
                        var month = date.getMonth()+1;
                        var day = date.getDate()-date.getDay();
                        var selectTime =year+"-"+month+"-"+day;
                        this.selectTime = selectTime;
                        this.selectType="selectTimePost";
                        this.getPlatePostInfo(getUrlParam('pl_type'),'selectTimePost',selectTime)
                    }else if(this.select1==4){
                        var date = new Date();
                        var year = date.getFullYear();
                        var month = date.getMonth();
                        var day = 0;
                        var selectTime =year+"-"+month+"-"+day;
                        this.selectTime = selectTime;
                        this.selectType="selectTimePost";
                        this.getPlatePostInfo(getUrlParam('pl_type'),'selectTimePost',selectTime)
					}else if(this.select1==5){
                        var date = new Date();
                        var year = date.getFullYear();
                        var month = date.getMonth()-2;
                        var day = 0;
                        var selectTime =year+"-"+month+"-"+day;
                        this.selectTime = selectTime;
                        this.selectType="selectTimePost";
                        this.getPlatePostInfo(getUrlParam('pl_type'),'selectTimePost',selectTime)
                    }
				},
                /*修改类型下拉框查看状态*/
                selectChange(){
                    //console.log("你好:"+this.select2)
                    if(this.select2==1){
                        this.selectType="default";
                        this.getPlatePostInfo(getUrlParam('pl_type'),'default')
                    }else if(this.select2==2){
                        this.selectType="new";
                        this.getPlatePostInfo(getUrlParam('pl_type'),'new')
                    }else if(this.select2==3){
                        this.selectType="hot";
                        this.getPlatePostInfo(getUrlParam('pl_type'),'hot')
                    }/*else if(this.select2==4){
                    this.getPlatePostInfo(getUrlParam('pl_type'),'default')
                }*/else if(this.select2==5){
                        this.selectType="lastPublish";
                        this.getPlatePostInfo(getUrlParam('pl_type'),'lastPublish')
                    }
                },
                /*获取主题数据*/

                /*切换置顶信息显示状态*/
                changeIsTopStatus(){

                    this.judgeIstopPost = !this.judgeIstopPost;
                    if(this.isTopInfo==''){
                        location.reload();
                    }
                   /* if(this.judgeIstopPost==true){
                      //  $("#isTops").html("显示置顶");
                        this.judgeIstopPost = !this.judgeIstopPost;
                    }else{
                      //  $("#isTops").html("置顶隐藏");
                        location.reload();
                    }*/
                },
                /*移除指定置顶数据*/
                deleteIsTop(val){
                    var newArr = this.isTopInfo.filter(item => item.id !== val);
                    this.isTopInfo=newArr;
                    /*this.isTopInfo=this.isTopInfo.filter(item => {
                            //如果数组中有包含keywords中的字符串,则返回true
                            if(!(item.id.includes(val))){
                                console.log(item)
                                return item;
                            }
                    })*/
                },
                // 每页显示的条数
                handleSizeChange(val) {
                },
                // 显示第几页
                handleCurrentChange(val) {
                    this.currentPage =val;
                    this.getPlatePostInfo(getUrlParam("pl_type"),this.selectType,this.selectTime)
                },
                initPosts(){
                    axios.get('/leek_bbs/bbs/postBrowse/findNewestPost').then(response => {
                        let data = response.data;
                        this.postHeats = data.postHeats;
                    }).catch(error => {
                        console.log(error);
                    })
				},
				getPlType(){
                    this.pl_type = getUrlParam("pl_type");
				}

			},
            mounted:function () {
                this.getTodayPostNum();
                this.getPlatePostInfo(getUrlParam("pl_type"),this.selectType);
                window['getPlatePostInfo'] = () => {  //将vue方法暴露给window对象,给外部调用
                    this.getPlatePostInfo(getUrlParam("pl_type"),this.selectType,this.selectTime)
					this.getTodayPostNum();
                }
            },
            created(){
                this.init();
                this.initPosts();
                this.getPlType();
				this.initTheme();  // 添加：初始化主题
			},
            filters:{
                formatDate(timestamp){
                    //timestamp是整数，否则要parseInt转换,不会出现少个0的情况
                    var time = new Date(timestamp);
                    var year = time.getFullYear();
                    var month = time.getMonth()+1;
                    var date = time.getDate();
                    var hours = time.getHours();
                    var minutes = time.getMinutes();
                    var seconds = time.getSeconds();
                    return year+'-'+month+'-'+date;
                },
                dateChangeFormat1(time){
                    return layui.dateChangeFormat(time);
                },
            }
        });
    },400);
    //Vue
	function initLayui() {
        layui.define(['util'],function (exports) {
            var util = layui.util;
            exports("dateChangeFormat",function (time) {
                return util.timeAgo(time, false);
            });

        });
		setTimeout(function () {
			initUserInfo();	 //判断用户是否登录
		},500);
		function initUserInfo() {
			console.log(this.userInfo)
			if(this.userInfo==null){
				$("#title").attr('disabled','disabled');//未登录禁用输入标题框
			}else if(userInfo != null){
				createEdit("editor_two");	//创建富文本编辑器
			}
		};
		/*$(document).on("click","#editBtn",function () {
			console.log(editor.txt.html());
			console.log(editor.txt.text());
		})*/
    }
</script>
</body>
</html>
