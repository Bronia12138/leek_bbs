<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>导读 - 现代社区</title>
	<link rel="icon" href="/leek_bbs/statics/images/favicon.ico" >
	<link rel="stylesheet" href="/leek_bbs/statics/yu-ui/js_css/yu.css">
	<link rel="stylesheet" href="/leek_bbs/statics/layui/css/layui.css">
	<link rel="stylesheet" href="/leek_bbs/statics/bootstrap-3.3.7/css/bootstrap.min.css">
	<link rel="stylesheet" href="/leek_bbs/statics/vue/element-ui/index.css">
	<link rel="stylesheet" href="/leek_bbs/statics/css/head.css">
	<link rel="stylesheet" href="/leek_bbs/statics/css/modern-ui.css">
	<link rel="stylesheet" href="/leek_bbs/statics/css/modern-ui-daodu.css">
	<style>
		/* 添加加载状态样式 */
		.user-loading {
			opacity: 0.6;
			pointer-events: none;
		}
		.avatar-error {
			width: 68px;
			height: 68px;
			border-radius: 50%;
			background-color: #f0f0f0;
			display: flex;
			align-items: center;
			justify-content: center;
			color: #999;
		}
	</style>
</head>
<body style="background-color: #F3F3F3">

<div id="modern-index-shell">
	<div id="hmc">
		<head_menu_comp :is_login="isLoginShow" ref="fo"></head_menu_comp>
	</div>

	<main class="daodu-page" data-page="daodu" id="daoDuApp" v-cloak>
		<div class="layui-container">
			<div class="modern-breadcrumb">
				<a href="/leek_bbs/skipPage/index"><span class="glyphicon glyphicon-home"></span></a>
				<span class="sep">/</span>
				<a href="/leek_bbs/skipPage/daodu">导读</a>
				<span class="sep">/</span>
				<span class="current">{{condition}}</span>
			</div>

			<div class="modern-toolbar card-shadow">
				<div class="filter-group" id="lay-btn">
					<div class="layui-col-sm11">
						<button class="filter-link" :class="{'is-active': chooseSelect=='NewHotPost'}" @click="getPostData('NewHotPost',1)">最新热门</button>
						<button class="filter-link" :class="{'is-active': chooseSelect=='NewEssencePost'}" @click="getPostData('NewEssencePost',1)">最新精华</button>
						<button class="filter-link" :class="{'is-active': chooseSelect=='NewReplyPost'}" @click="getPostData('NewReplyPost',1)">最新回复</button>
						<button class="filter-link" :class="{'is-active': chooseSelect=='NewPublishPost'}" @click="getPostData('NewPublishPost',1)">最新发表</button>
						<button class="filter-link" :class="{'is-active': chooseSelect=='SofaPost'}" @click="getPostData('SofaPost',1)">抢沙发</button>
						<button class="filter-link" id="myPost" @click="getPostData('MyPost',1)" v-show="checkLoginStatus">我的帖子</button>
					</div>
				</div>
				<button class="modern-btn-primary" id="btnShow">
					<i class="layui-icon layui-icon-add-1"></i> 发表最新主题
				</button>
			</div>

			<div class="list-header-row">
				<div class="col-title">标题内容</div>
				<div class="col-info">版块 / 作者</div>
				<div class="col-stat">统计 / 最后发表</div>
			</div>

			<!-- 修改：使用 item.userInfo 而不是全局的 leadUserInfo -->
			<div class="post-item-card card-shadow" v-for="(item, index) in postInfo">
				<div class="post-main">
					<div class="post-title-line">
						<span class="post-icon"><i class="layui-icon layui-icon-dialogue"></i></span>
						<a :href="'/leek_bbs/skipPage/blogPage?theme_id='+item.id"
						   target="_blank"
						   class="post-title"
						   @click="handleBrowseCount(item.id)">{{item.title}}</a>
					</div>
					<div class="post-meta-line">
						<span class="plate-label">{{item.plate.plate_name}}</span>
						<span class="meta-dot">·</span>
						<div class="author-wrap"
							 @mouseenter="showUserCard(item.user_id, index, $event)"
							 @mouseleave="scheduleHideCard">
							<a href="javascript:;" class="author-link">
								{{item.post_author}}
							</a>
							<!-- 修改：使用 item.userInfo 显示用户卡片 -->
							<div class="dropdown-content modern-user-card" v-if="item.userInfo">
								<div class="user-card-body">
									<div class="user-avatar">
										<!-- 修改：使用 item.userInfo.picture -->
										<img :src="getUserAvatar(item.userInfo.picture)"
											 alt="avatar"
											 @error="handleAvatarError($event, index)">
									</div>
									<div class="user-info">
										<div class="user-nick">
											{{item.userInfo.another_name}}
											<span class="grade-tag" v-if="item.gradeInfo">{{item.gradeInfo.name}}</span>
										</div>
										<div class="user-sign">{{item.userInfo.personalized_sign || '暂无签名'}}</div>
									</div>
								</div>
								<div class="user-card-actions">
									<button class="mini-btn" @click="followUser(item.user_id)">关注</button>
									<button class="mini-btn" @click="sendMessage(item.user_id)">私信</button>
								</div>
							</div>
						</div>
						<span class="meta-dot">·</span>
						<span class="time-tag">{{changePublishTime(item.publish_time)}}</span>
					</div>
				</div>

				<div class="post-side-data">
					<div class="stat-group">
						<div class="stat-unit">
							<span class="num">{{item.browse_count}}</span>
							<span class="lab">查看</span>
						</div>
						<div class="stat-unit">
							<span class="num">{{item.reply_count}}</span>
							<span class="lab">回复</span>
						</div>
					</div>
					<div class="last-reply-box">
						<span class="last-user">{{item.last_reply}}</span>
						<span class="last-time">{{changePublishTime(item.last_reply_time)}}</span>
					</div>
				</div>
			</div>

			<div class="pagination-wrapper">
				<el-pagination
						background
						layout="prev, pager, next"
						prev-text="上一页"
						next-text="下一页"
						@current-change="handleCurrentChange"
						:current-page="currentPage"
						:page-size="pageSize"
						:total="totalCount">
				</el-pagination>
			</div>
		</div>

		<div class="modern-backtop" onclick="window.scrollTo(0,0)">
			<i class="layui-icon layui-icon-top"></i>
		</div>
		<div class="floating-user-card"
			 v-show="hoverUser.visible"
			 :style="{ top: hoverUser.top + 'px', left: hoverUser.left + 'px' }"
			 @mouseenter="hoverUser.lock = true"
			 @mouseleave="hideUserCardImmediately">

			<div class="user-card-body">
				<div class="user-avatar">
					<img :src="getUserAvatar(hoverUser.userInfo.picture)">
				</div>
				<div class="user-info">
					<div class="user-nick">
						{{hoverUser.userInfo.another_name}}
						<span class="grade-tag" v-if="hoverUser.gradeInfo">
                    {{hoverUser.gradeInfo.name}}
                </span>
					</div>
					<div class="user-sign">
						{{hoverUser.userInfo.personalized_sign || '暂无签名'}}
					</div>
				</div>
			</div>

			<div class="user-card-actions">
				<button class="mini-btn">关注</button>
				<button class="mini-btn">私信</button>
			</div>
		</div>

	</main>
</div>

<script src="/leek_bbs/statics/component/common_import.js"></script>
<script src="/leek_bbs/statics/vue/element-ui/index.js"></script>
<script src="/leek_bbs/statics/component/head_menu.js"></script>
<script src="/leek_bbs/statics/component/wangEditor.min.js"></script>
<script src="/leek_bbs/statics/component/wangEditCommon.js"></script>

<script>
	setTimeout(function () {
		new Vue({
			el:"#daoDuApp",
			data:{
				pageSize:10,
				currentPage:1,
				totalCount:0,
				login_userId:'',
				checkLoginStatus:false,
				postInfo:[],
				chooseSelect: "SelectPost",
				// 移除全局的 leadUserInfo 和 gradeInfo
				// leadUserInfo:{}, // ❌ 删除这个
				// gradeInfo:{},    // ❌ 删除这个
				plateId: '',
				condition:'全部',
				userInfoCache: {}, // ✅ 新增：用户信息缓存
				pendingRequests: {}, // ✅ 新增：防止重复请求
				hoverUser: {
					visible: false,
					top: 0,
					left: 0,
					userInfo: {},
					gradeInfo: {},
					lock: false,
					timer: null
				}
			},
			methods:{
				scheduleHideCard() {
					this.hoverUser.timer = setTimeout(() => {
						if (!this.hoverUser.lock) {
							this.hoverUser.visible = false;
						}
					}, 150);
				},
				hideUserCardImmediately() {
					this.hoverUser.visible = false;
				},

				showUserCard(userId, index, event) {
					clearTimeout(this.hoverUser.timer);

					const rect = event.target.getBoundingClientRect();
					const cardWidth = 280;
					const gap = 8;

					let left = rect.left;
					if (rect.left + cardWidth > window.innerWidth) {
						left = rect.right - cardWidth;
					}

					this.hoverUser.top = rect.bottom + gap;
					this.hoverUser.left = left;
					this.hoverUser.visible = true;
					this.hoverUser.lock = false;

					// 缓存命中
					if (this.userInfoCache[userId]) {
						this.hoverUser.userInfo = this.userInfoCache[userId].userInfo;
						this.hoverUser.gradeInfo = this.userInfoCache[userId].gradeInfo;
						return;
					}

					// 拉取数据（不再依赖 postIndex）
					this.fetchUserInfoForHover(userId);
				},
				fetchGradeInfoForHover(totalExperience, userId) {
					$.ajax({
						type: "post",
						url: "/leek_bbs/bbs/user/getGrade",
						data: { totalExperience },
						dataType: "json",
						success: (response) => {
							if (this.userInfoCache[userId]) {
								this.userInfoCache[userId].gradeInfo = response;
							}
							this.hoverUser.gradeInfo = response;
						}
					});
				},
				fetchUserInfoForHover(userId) {
					// 防重复请求
					if (this.pendingRequests[userId]) return;
					this.pendingRequests[userId] = true;

					$.ajax({
						type: "post",
						url: "/leek_bbs/bbs/userPost/leadUserInfo",
						data: { userId },
						dataType: "json",
						success: (response) => {
							delete this.pendingRequests[userId];

							// 缓存
							this.userInfoCache[userId] = {
								userInfo: response,
								gradeInfo: null
							};

							// 设置到悬浮卡片
							this.hoverUser.userInfo = response;

							// 拉等级
							this.fetchGradeInfoForHover(response.experience.total_experience, userId);
						},
						error: () => {
							delete this.pendingRequests[userId];
						}
					});
				},


				handleBrowseCount(postId) {
					axios.get("http://localhost:8080/leek_bbs/bbs/postBrowse/clickAddBrowseCount", {
						params: { id: postId }
					}).then(response => {
						if (response.data === 1) {
							const targetItem = this.postInfo.find(item => item.id === postId);
							if (targetItem) {
								targetItem.browse_count = (targetItem.browse_count || 0) + 1;
							}
						}
					}).catch(error => {
						console.error("浏览次数增加失败", error);
					});
				},

				// ✅ 新增：处理鼠标悬停事件
				handleUserHover(userId, postIndex) {
					// 如果正在加载中，直接返回
					if (this.postInfo[postIndex].loadingUserInfo) return;

					// 如果已经有用户信息，直接显示卡片
					if (this.postInfo[postIndex].userInfo) return;

					// 从缓存中获取用户信息
					if (this.userInfoCache[userId]) {
						this.postInfo[postIndex].userInfo = this.userInfoCache[userId].userInfo;
						this.postInfo[postIndex].gradeInfo = this.userInfoCache[userId].gradeInfo;
						return;
					}

					// 设置加载状态
					this.$set(this.postInfo[postIndex], 'loadingUserInfo', true);

					// 防止重复请求
					if (this.pendingRequests[userId]) return;
					this.pendingRequests[userId] = true;

					// 获取用户信息
					this.fetchUserInfo(userId, postIndex);
				},

				// ✅ 新增：获取用户信息（带缓存）
				fetchUserInfo(userId, postIndex) {
					var that = this;
					$.ajax({
						type:"post",
						url: "/leek_bbs/bbs/userPost/leadUserInfo",
						data:{ userId:userId },
						dataType: "json",
						success:function (response) {
							this.hoverUser.userInfo = response;
							this.hoverUser.gradeInfo = null;

							// 清除请求标记
							delete that.pendingRequests[userId];

							// 清除加载状态
							that.$set(that.postInfo[postIndex], 'loadingUserInfo', false);

							// 存储到缓存
							that.userInfoCache[userId] = {
								userInfo: response,
								gradeInfo: null // 稍后获取等级信息
							};

							// 设置到当前帖子项
							that.$set(that.postInfo[postIndex], 'userInfo', response);

							// 获取等级信息
							that.fetchGradeInfo(response.experience.total_experience, userId, postIndex);
							this.hoverUser.gradeInfo = response;

						},
						error: function(error) {
							console.log("获取用户信息失败", error);
							delete that.pendingRequests[userId];
							that.$set(that.postInfo[postIndex], 'loadingUserInfo', false);
						}
					});
				},

				// ✅ 新增：获取等级信息
				fetchGradeInfo(totalExperience, userId, postIndex) {
					var that = this;
					$.ajax({
						type:"post",
						url: "/leek_bbs/bbs/user/getGrade",
						data:{ totalExperience: totalExperience },
						dataType: "json",
						success:function (response) {
							// 更新缓存中的等级信息
							if (that.userInfoCache[userId]) {
								that.userInfoCache[userId].gradeInfo = response;
							}

							// 设置到当前帖子项
							that.$set(that.postInfo[postIndex], 'gradeInfo', response);
						},
						error: function(error) {
							console.log("获取等级信息失败", error);
						}
					});
				},

				// ✅ 新增：获取用户头像URL
				// 修正 getUserAvatar 方法
				getUserAvatar(picturePath) {
					if (!picturePath || picturePath === 'undefined' || picturePath === 'null') {
						return '/leek_bbs/statics/images/default-avatar.png';
					}

					// 如果已经是完整路径，直接返回
					if (picturePath.startsWith('http') || picturePath.startsWith('/')) {
						return picturePath;
					}

					// 否则拼接基础路径
					return '/leek_bbs/' + picturePath;
				},

				// ✅ 新增：处理头像加载错误
				handleAvatarError(event, index) {
					event.target.src = '/leek_bbs/statics/images/default-avatar.png';
					// 防止再次触发错误
					event.target.onerror = null;
				},

				// ✅ 新增：关注用户
				followUser(userId) {
					console.log('关注用户:', userId);
					// 这里可以添加关注用户的逻辑
					alert('关注功能待实现');
				},

				// ✅ 新增：发送私信
				sendMessage(userId) {
					console.log('发送私信给:', userId);
					// 这里可以添加发送私信的逻辑
					alert('私信功能待实现');
				},

				checkLogin(){
					if (userInfo != null){
						this.login_userId = userInfo.id;
						this.checkLoginStatus = true;
					}
				},

				getPostData(chooseSelect, tag){
					var that = this;
					if(tag != null){
						that.currentPage = 1;
					}

					$.ajax({
						type: "post",
						url: "/leek_bbs/bbs/userPost/findClassifyPost",
						data:{
							PageSize: that.pageSize,
							PageCurrent: that.currentPage,
							chooseSelect: chooseSelect,
							userId: that.login_userId,
						},
						dataType:"json",
						success: function(response) {
							// 为每个帖子项初始化用户信息字段
							response.list.forEach(item => {
								item.userInfo = null;
								item.gradeInfo = null;
								item.loadingUserInfo = false;
							});

							that.postInfo = response.list;
							that.totalCount = response.total;
							that.chooseSelect = chooseSelect;
						},
						error: function(error) {
							console.log("获取帖子数据失败", error);
						}
					});
				},

				handleCurrentChange(val) {
					this.currentPage = val;
					this.getPostData(this.chooseSelect);
				},

				changePublishTime(dateTimeStamp){
					var minute = 1000 * 60;
					var hour = minute * 60;
					var day = hour * 24;
					var month = day * 30;
					var year = day * 365;
					var now = new Date().getTime();
					var diffValue = now - dateTimeStamp;

					if(diffValue < 0){ return "未来"; }
					var yearC = diffValue / year;
					var monthC = diffValue / month;
					var dayC = diffValue / day;
					var hourC = diffValue / hour;
					var minC = diffValue / minute;

					if(yearC >= 1) return parseInt(yearC) + "年前";
					if(monthC >= 1) return parseInt(monthC) + "月前";
					if(dayC >= 1) return parseInt(dayC) + "天前";
					if(hourC >= 1) return parseInt(hourC) + "小时前";
					if(minC >= 1) return parseInt(minC) + "分钟前";
					return "刚刚";
				}
			},
			mounted: function() {
				this.getPostData(this.chooseSelect);
				this.checkLogin();

				if (getUrlName("my_post")) {
					this.getPostData("MyPost", 1);
					$("#myPost").addClass('is-active');
				}
			},
			created() {
				loadingLayui();
			}
		});
	}, 200);

	layui.use(['layer'], function(){
		var layer = layui.layer;
		$(document).on('click','#btnShow',function () {
			if (userInfo == null){
				layer.msg("请先登录...", {icon: 2, time:'1500'}, function() {
					layui.login();
				});
			} else {
				layer.open({
					type: 2,
					content: '/leek_bbs/skipPage/sendArticle',
					area: ['600px', '400px'],
					title: '发布话题'
				});
			}
		});
	});

	function loadingLayui(){
		layui.define(['layer','element'], function(exports){
			var layer = layui.layer;
			exports('openSendPost', function (plateId) {
				top.layer.open({
					type: 1,
					content: `<div style="padding:20px">编辑器加载中...</div>`,
					area: ['800px', '600px'],
					title: '发表新主题'
				});
			});
		});
	}

	function getUrlName(name) {
		return window.location.href.indexOf(name) != -1;
	}
</script>
</body>
</html>
